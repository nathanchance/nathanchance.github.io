<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building and using Cuttlefish | Nathan Chancellor</title>
<meta name="keywords" content="android, clang, linux">
<meta name="description" content="Recently, I stumbled upon a talk that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from adb shell.">
<meta name="author" content="Nathan Chancellor">
<link rel="canonical" href="https://nathanchance.dev/posts/building-using-cuttlefish/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css" integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://nathanchance.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nathanchance.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nathanchance.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nathanchance.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://nathanchance.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Building and using Cuttlefish" />
<meta property="og:description" content="Recently, I stumbled upon a talk that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from adb shell." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nathanchance.dev/posts/building-using-cuttlefish/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-01-31T18:52:00-07:00" />
<meta property="article:modified_time" content="2020-01-31T18:52:00-07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building and using Cuttlefish"/>
<meta name="twitter:description" content="Recently, I stumbled upon a talk that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from adb shell."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nathanchance.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Building and using Cuttlefish",
      "item": "https://nathanchance.dev/posts/building-using-cuttlefish/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building and using Cuttlefish",
  "name": "Building and using Cuttlefish",
  "description": "Recently, I stumbled upon a talk that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from adb shell.",
  "keywords": [
    "android", "clang", "linux"
  ],
  "articleBody": "Recently, I stumbled upon a talk that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from adb shell. Cuttlefish boots in around 20 seconds on my machine and swapping out kernels is as simple as adding two command flags which I will go over later. If you are running Cuttlefish locally, you can even view it with TightVNC.\nA brief demo:\nA few things to note:\nThese commands assume that you understand Linux shell commands and structure; do not blindly copy and paste (even though everything should work without any issues). If you have any questions about what something is specifically doing and I did not make it clear enough here, feel free to reach out to me on Twitter (link on my homepage).\nAll of the commands are specifically for Ubuntu. This is the OS that I use with my Packet servers and all that I really test on. I tested both bash and zsh without any issues. Debian should work but since we are dealing with fairly low level stuff like KVM, there might be minor differences that are not accounted for here.\n1. Getting Cuttlefish running The first thing to do is actually get the images and tools we need downloaded and installed. This has mostly been distilled from the official README. Cuttlefish uses KVM for performance so your device must support virtualization. See this page for how to determine that and consult Google for how to enable it in your BIOS if it is not already.\nTo start, we need to grab a bunch of packages that are essential to this process:\n$ sudo apt install -y build-essential devscripts fakeroot git psmisc qemu-kvm unzip zip Next, we will make a folder to contain all of the work we are doing. This can be anywhere but you will need to adjust the rest of the commands for wherever you put it.\n$ mkdir -p \"${HOME}\"/cuttlefish-playground/src After this, we will clone the android-cuttlefish repo locally. This will configure and install some tools that are necessary to boot Cuttlefish. Most of these tools are for development, the main reason to install this package is to get the groups that Cuttlefish needs configured properly. There is also the option of using a Docker image to do this but when I tried to use it, I could not get it to work.\n$ git clone https://github.com/google/android-cuttlefish \"${HOME}\"/cuttlefish-playground/src/android-cuttlefish $ cd \"${HOME}\"/cuttlefish-playground/src/android-cuttlefish Once the repo has been successfully cloned, we need to install a couple of prerequisite packages specifically for this package we are about to build.\n$ sudo apt install -y cdbs config-package-dev debhelper After those have been installed, we will build the package:\n$ debuild -i -us -uc -b The package should have built successfully. If it did not, see if it says a package is missing or try Googling the error to get it resolved. Once it is built, try to install it.\n$ sudo dpkg -i ../cuttlefish-common_*_amd64.deb That step will fail. The packages that it depends on can be installed along with it by running the following command:\n$ sudo apt-get install -f -y Once it gets installed successfully, the cuttlefish-* packages can be removed to avoid cluttering up the workspace.\n$ rm ../cuttlefish-* After this, we need to add our user to the cvdnetwork and kvm network so that Cuttlefish is allowed to use KVM to boot and configure its network using vsock.\n$ sudo usermod -aG cvdnetwork \"${USER}\" $ sudo usermod -aG kvm \"${USER}\" Once that is done, logout and log back in (or reboot your machine if it is a remote server).\nAfter logging back in, we need to grab prebuilt versions of the Cuttlefish host tools (such as the launch_cvd and stop_cvd commands) as well as the filesystem images, much like a regular Android device, which include super.img, vendor.img, and boot.img. I will show you how to build these from source if you ever want to hack on Cuttlefish later.\nWe will first create an area for all of this to exist.\n$ mkdir -p \"${HOME}\"/cuttlefish-playground/cuttlefish-fs $ cd \"${HOME}\"/cuttlefish-playground/cuttlefish-fs The files we need are all available from ci.android.com. There will be a LOT of different options, the one we care about is currently the second column: aosp_cf_x86_phone. If you click on the userdebug button, it will automatically give you the last known good build. From there, click on the button with the arrow then click on Artifacts. The files we need to download are aosp_cf_x86_phone-img-*.zip and cvd-host_package.tar.gz.\nThis one-liner will grab the zip, unzip it, and remove it. I recommend using the latest, known good build, instead of the one that I have linked here.\n$ curl -LSsO https://ci.android.com/builds/submitted/6173731/aosp_cf_x86_phone-userdebug/latest/aosp_cf_x86_phone-img-6173731.zip \u0026\u0026 \\ unzip *.zip \u0026\u0026 \\ rm *.zip This one-liner will grab the host tools and untar it.\n$ curl -LSs https://ci.android.com/builds/submitted/6173731/aosp_cf_x86_phone-userdebug/latest/cvd-host_package.tar.gz | tar -xzf - Once those have finished downloading, we are ready to run Cuttlefish! We start Cuttlefish using the launch_cvd (Launch Cuttlefish Virtual Device).\n$ HOME=${PWD} ./bin/launch_cvd -daemon The HOME=${PWD} is present so that some Cuttlefish runtime files get contained to this folder. The -daemon flag is so that we can interact with Cuttlefish through adb shell in the same terminal window (i.e. it gets sent to the background). You should see a bunch of text fire up then it end with something like:\nrun_cvd I 01-31 20:07:50 9571 9571 main.cc:198] VIRTUAL_DEVICE_BOOT_COMPLETED launch_cvd I 01-31 20:07:50 9543 9543 launch_cvd.cc:131] run_cvd exited successfully. It takes about 20 seconds for Cuttlefish to boot up for me (which is extremely impressive in my opinion). After that, you can run adb to connect to it. You might need to run the command a couple of times so that adb can start and connect to the device but once you do, you should be able to interact with it like any other Android device.\n$ ./bin/adb shell vsoc_x86:/ $ I like to see what kernel it is running, which at this point is the android-5.4 branch, the latest LTS kernel.\nvsoc_x86:/ $ cat /proc/version Linux version 5.4.15-gb2b96d09ef40 (android-build@abfarm-01061) (Android (6051079 based on r370808) clang version 10.0.1 (https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244)) #1 SMP PREEMPT Mon Jan 27 13:04:43 UTC 2020 You can see that it actively running tasks by typing in top. Once you are done exploring and want to move on, shutdown this instance by calling stop_cvd:\n$ HOME=${PWD} ./bin/stop_cvd 2. Building your own kernel Now that we have gotten Cuttlefish running, it’s time to explore one of the main reasons that I use it, which is validating Android kernels. Android has cool technologies in the kernel such as LTO and CFI, which are not currently in mainline. Replacing Cuttlefish’s prebuilt kernel is extremely easy, which is one of the main selling points; it makes it really easy for kernel hackers to get involved with it, especially with Google’s kernel build system. This section is expanded from Google’s official documentation.\nFirst, we need to do is grab repo, Google’s git management tool. If you already have repo installed, just skip this portion. Alternatively, you can install repo into /usr/local/bin so that it is automatically added to PATH but for the sake of this tutorial, I keep everything localized as much as possible.\nCreate a bin folder within the Cuttlefish area.\n$ mkdir -p \"${HOME}\"/cuttlefish-playground/bin Download repo into the bin folder.\n$ curl -LSso \"${HOME}\"/cuttlefish-playground/bin/repo https://storage.googleapis.com/git-repo-downloads/repo Make it executable.\n$ chmod a+x \"${HOME}\"/cuttlefish-playground/bin/repo Add the bin folder to PATH (NOTE: If you close out of your terminal session or start a new one, you will need to do this everytime):\n$ export PATH=${HOME}/cuttlefish-playground/bin:${PATH} If you have not already configured git with your email address and your full name, do so now:\n$ git config --global user.email \"you@domain.com\" $ git config --global user.name \"Your Name After all of this has been configured, we are going to download the kernel source. Depending on your internet speed, this might take some time.\nWe will create a folder for that source to be saved in. This will also download all of the prebuilt tools we need, such as the compiler and binaries used during the build process.\n$ mkdir -p \"${HOME}\"/cuttlefish-playground/kernel-common $ cd \"${HOME}\"/cuttlefish-playground/kernel-common Next, we will download the source. I am using the common-android-mainline branch since it is the latest available and where most of the new development happens but you can use common-android-5.4 or common-android-4.19 branches if you would like. Any time that you want to get the latest new changes, you can just run repo sync.\n$ repo init -u https://android.googlesource.com/kernel/manifest -b common-android-mainline $ repo sync Once it is done downloading, we need to make sure that we have the SSL development headers installed, otherwise our build will error out. Google’s build is almost heremetic, except for this:\n$ sudo apt install -y libssl-dev Finally, we are ready to build the kernel. Google’s build script takes care of everything as long as we specify a build config, which is build.config.cuttlefish.x86_64 in our case. We need to copy the bzImage into the dist folder because Google’s build.config.cuttlefish.x86_64 is only intended to save the initramfs.img; however, the build.config.gki.x86_64 is about to be fully demodularized and we are eventually going to use a different compiler than Google’s official one, which will create a mismatch. As a result, we need to do that copy on our own (it isn’t strictly necessary, it just makes everything end up in the right spot).\n$ BUILD_CONFIG=common/build.config.cuttlefish.x86_64 ./build/build.sh $ cp out/android-mainline/common/arch/x86/boot/bzImage out/android-mainline/dist/bzImage Once it is done building, we can use that kernel and ramdisk to boot from. launch_cvd has two flags we need to use, -initramfs_path (for the ramdisk that has all of the kernel modules) and -kernel_path for the actual kernel binary. These two files are available in the out//dist folder (e.g., out/android-mainline/dist). I would recommend exporting this to a variable that can be easily used later.\n$ DIST_FOLDER=$(readlink -f out/android-mainline/dist) Once you do that, we will move back to the cuttlefish-fs folder and use these freshly built files to boot Cuttlefish from:\n$ cd \"${HOME}\"/cuttlefish-playground/cuttlefish-fs $ HOME=${PWD} ./bin/launch_cvd -daemon -initramfs_path \"${DIST_FOLDER}\"/initramfs.img -kernel_path \"${DIST_FOLDER}\"/bzImage After that, we can use adb shell to see that we indeed used our own kernel since it shows a newer version, different user/hostname, and the repo that we used and that all of the modules properly loaded.\n$ ./bin/adb shell vsoc_x86:/ $ cat /proc/version Linux version 5.5.0-mainline-03266-g1dad8acc36fc (nathan@g2-large-x86) (Android (6051079 based on r370808) clang version 10.0.1 (https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244)) #1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 21:42:55 vsoc_x86:/ $ lsmod Module Size Used by vsock_loopback 16384 0 vmw_vsock_virtio_transport 24576 3 vmw_vsock_virtio_transport_common 36864 2 vsock_loopback,vmw_vsock_virtio_transport vsock_diag 16384 0 vsock 53248 16 vsock_loopback,vmw_vsock_virtio_transport,vmw_vsock_virtio_transport_common,vsock_diag can_raw 20480 0 can 28672 1 can_raw snd_intel8x0 45056 1 snd_ac97_codec 229376 1 snd_intel8x0 ac97_bus 16384 1 snd_ac97_codec virtio_input 20480 0 virtio_pci 28672 0 virtio_mmio 20480 0 gnss_cmdline 16384 0 gnss_serial 16384 1 gnss_cmdline virtio_crypto 28672 0 dummy_cpufreq 16384 0 rtc_test 16384 1 dummy_hcd 32768 0 can_dev 32768 0 vcan 16384 0 virtio_net 53248 0 net_failover 24576 1 virtio_net failover 16384 1 net_failover virt_wifi 24576 1 virtio_pmem 16384 1 nd_virtio 16384 1 virtio_pmem virtio_blk 24576 5 virtio_gpu 57344 0 virtio_console 36864 0 virtio_rng 16384 0 virtio_ring 36864 11 vmw_vsock_virtio_transport,virtio_input,virtio_pci,virtio_mmio,virtio_crypto,virtio_net,nd_virtio,virtio_blk,virtio_gpu,virtio_console,virtio_rng virtio 24576 11 vmw_vsock_virtio_transport,virtio_input,virtio_pci,virtio_mmio,virtio_crypto,virtio_net,virtio_pmem,virtio_blk,virtio_gpu,virtio_console,virtio_rng blk_mq_virtio 16384 1 virtio_blk binfmt_misc 20480 0 Once you are done exploring, stop Cuttlefish.\n$ HOME=${PWD} ./bin/stop_cvd 3. Using upstream LLVM One of my hobbies is contributing to ClangBuiltLinux, which involves building various Linux kernels with the master version of Clang (11.0.0 at the time of writing this). As a part of that project, I have developed a script that can build a self-contained version of Clang suitable for building kernels. These steps will show you how to build that version of Clang then use it within the Android build system.\nFirst, we need to install some packages that allow us build Clang efficiently (including Clang itself):\n$ sudo apt install -y bc bison ccache clang cmake flex libelf-dev lld ninja-build python3 u-boot-tools zlib1g-dev Next, we’ll grab the repo that contains the Python script:\n$ git clone git://github.com/ClangBuiltLinux/tc-build \"${HOME}\"/cuttlefish-playground/src/tc-build By default, the script does a two stage LLVM build (builds a small version of LLVM then uses that to build a full version of LLVM).\n$ \"${HOME}\"/cuttlefish-playground/src/tc-build/build-llvm.py If for some reason your machine cannot handle that, you can just do a stage 1 build.\n$ \"${HOME}\"/cuttlefish-playground/src/tc-build/build-llvm.py --build-stage1-only --install-stage1-only If you have a machine with good performance, I would recommend using the --pgo flag to build with Profile Guided Optimization; this can result in a 20% speed up when compiling kernels.\n$ \"${HOME}\"/cuttlefish-playground/src/tc-build/build-llvm.py --pgo If for some reason there are any issues using the script, please report them here so I can triage them.\nOnce the toolchain has been built, we will make it available to easily use by symlinking the install folder within tc-build into the prebuilts folder in kernel-common.\n$ ln -s \"${HOME}\"/cuttlefish-playground/src/tc-build/install \"${HOME}\"/cuttlefish-playground/kernel-common/prebuilts-master/clang/host/linux-x86/cbl-clang-master After that, we can use sed to automatically use that Clang when building the kernel.\n$ cd \"${HOME}\"/cuttlefish-playground/kernel-common $ sed -i 's/clang-r.*/cbl-clang-master\\/bin/g' common/build.config.common $ BUILD_CONFIG=common/build.config.cuttlefish.x86_64 ./build/build.sh $ cp out/android-mainline/common/arch/x86/boot/bzImage out/android-mainline/dist/bzImage Once the build is completed, we just use the same commands as before to boot and test:\n$ DIST_FOLDER=$(readlink -f out/android-mainline/dist) $ cd \"${HOME}\"/cuttlefish-playground/cuttlefish-fs $ HOME=${PWD} ./bin/launch_cvd -daemon -initramfs_path \"${DIST_FOLDER}\"/initramfs.img -kernel_path \"${DIST_FOLDER}\"/bzImage $ ./bin/adb shell vsoc_x86:/ $ cat /proc/version Linux version 5.5.0-mainline-03266-g1dad8acc36fc-dirty (nathan@g2-large-x86) (ClangBuiltLinux clang version 11.0.0 (git://github.com/llvm/llvm-project 64cb77b9469207799e570483dadc720dbf12c794)) #1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 23:47:57 vsoc_x86:/ $ exit $ HOME=${PWD} ./bin/stop_cvd 4. Building Cuttlefish userspace from scratch If you want to test the latest and greatest from AOSP’s master branch, you can build the things that are in the cuttlefish-fs folder from scratch.\nThis is not small so make sure that you have room on your hard drive for it. A fresh checkout as of today shows:\n$ diskus . 92.68 GB (92,677,562,368 bytes) First, use repo to go and grab the full AOSP source tree.\n$ mkdir -p \"${HOME}\"/cuttlefish-playground/src/aosp $ cd \"${HOME}\"/cuttlefish-playground/src/aosp $ repo init -u https://android.googlesource.com/platform/manifest $ repo sync Next, we need source Android’s environment setup script to adjust the PATH variable and add the functions that it uses.\n$ . build/envsetup.sh After that, we need to use the lunch command to tell the build system that we want to build Cuttlefish.\n$ lunch aosp_cf_x86_phone-userdebug Next, we’re just going to build the world:\n$ m This will probably take a while since there are usually around 80,000+ files to build. A clean build on g2.large.x86 takes about 38 minutes.\nOnce it is done, you can use the launch_cvd command available in PATH to use the new files you just build. The HOME= assignment should still be used to keep the Cuttlefish runtime files contained but I will keep them in the out folder.\n$ HOME=${PWD}/out launch_cvd -daemon Once it has booted, you can access with the adb that is in the path.\n$ adb shell vsoc_x86:/ $ cat /proc/version Linux version 5.4.15-gb2b96d09ef40 (android-build@abfarm-01061) (Android (6051079 based on r370808) clang version 10.0.1 (https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244)) #1 SMP PREEMPT Mon Jan 27 13:04:43 UTC 2020 The kernel is still prebuilt but you can use a kernel that you build earlier with this new userspace just like before.\n$ HOME=${PWD}/out launch_cvd -daemon -initramfs_path \"${DIST_FOLDER}\"/initramfs.img -kernel_path \"${DIST_FOLDER}\"/bzImage $ adb shell vsoc_x86:/ $ cat /proc/version Linux version 5.5.0-mainline-03266-g1dad8acc36fc-dirty (nathan@g2-large-x86) (ClangBuiltLinux clang version 11.0.0 (git://github.com/llvm/llvm-project 64cb77b9469207799e570483dadc720dbf12c794)) #1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 23:47:57 Conclusion Hopefully this was informative for you! Some further things to potentially explore are things like adeb, which allow you to use tracing tools and other Linux utilities on Android to poke around its internals and try and improve or break things or looking into some of the new cool things they are doing like Apex. If you have any questions or problems, feel free to reach out to me on Twitter or GitHub, both of which are linked on my homepage.\n",
  "wordCount" : "2672",
  "inLanguage": "en",
  "datePublished": "2020-01-31T18:52:00-07:00",
  "dateModified": "2020-01-31T18:52:00-07:00",
  "author":{
    "@type": "Person",
    "name": "Nathan Chancellor"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nathanchance.dev/posts/building-using-cuttlefish/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nathan Chancellor",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nathanchance.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nathanchance.dev/" accesskey="h" title="Nathan Chancellor (Alt + H)">Nathan Chancellor</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nathanchance.dev/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/nc_resume.pdf" title="Resume">
                    <span>Resume</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/downloads/" title="Downloads">
                    <span>Downloads</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Building and using Cuttlefish
    </h1>
    <div class="post-meta"><span title='2020-01-31 18:52:00 -0700 MST'>January 31, 2020</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Nathan Chancellor&nbsp;|&nbsp;<a href="https://github.com/nathanchance/hugo-files/blob/main/content/posts/building-using-cuttlefish.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul><ul>
                <li>
                    <a href="#1-getting-cuttlefish-running" aria-label="1. Getting Cuttlefish running">1. Getting Cuttlefish running</a></li>
                <li>
                    <a href="#2-building-your-own-kernel" aria-label="2. Building your own kernel">2. Building your own kernel</a></li>
                <li>
                    <a href="#3-using-upstream-llvm" aria-label="3. Using upstream LLVM">3. Using upstream LLVM</a></li>
                <li>
                    <a href="#4-building-cuttlefish-userspace-from-scratch" aria-label="4. Building Cuttlefish userspace from scratch">4. Building Cuttlefish userspace from scratch</a></li></ul>
                    
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Recently, I stumbled upon <a href="https://youtu.be/xMtDDEj-02c?t=9502">a talk</a> that Alistair Delva, a Google engineer, gave at the 2018 Linux Plumbers Conference around Cuttlefish, an Android Virtual Device (AVD) that is used to validate the Android platform virtually (i.e. without a separate device). This is something that is really cool because it makes it easy to follow along with upstream Android development and see what changes they are making under the hood, all from <code>adb shell</code>. Cuttlefish boots in around 20 seconds on my machine and swapping out kernels is as simple as adding two command flags which I will go over later. If you are running Cuttlefish locally, you can even <a href="https://android.googlesource.com/device/google/cuttlefish/#so-you-want-to-see-cuttlefish">view it</a> with TightVNC.</p>
<p>A brief demo:</p>
<p><a href="https://asciinema.org/a/tfDhVZKCL0URqP58lnxuRsKZd"><img loading="lazy" src="https://asciinema.org/a/tfDhVZKCL0URqP58lnxuRsKZd.svg" alt="asciicast"  />
</a></p>
<p>A few things to note:</p>
<ol>
<li>
<p>These commands assume that you understand Linux shell commands and structure; do not blindly copy and paste (even though everything should work without any issues). If you have any questions about what something is specifically doing and I did not make it clear enough here, feel free to reach out to me on Twitter (link on my homepage).</p>
</li>
<li>
<p>All of the commands are specifically for Ubuntu. This is the OS that I use with my <a href="https://www.packet.com/">Packet</a> servers and all that I really test on. I tested both <code>bash</code> and <code>zsh</code> without any issues. Debian <em>should</em> work but since we are dealing with fairly low level stuff like KVM, there might be minor differences that are not accounted for here.</p>
</li>
</ol>
<h2 id="1-getting-cuttlefish-running">1. Getting Cuttlefish running<a hidden class="anchor" aria-hidden="true" href="#1-getting-cuttlefish-running">#</a></h2>
<p>The first thing to do is actually get the images and tools we need downloaded and installed. This has mostly been distilled from <a href="https://android.googlesource.com/device/google/cuttlefish/#so-you-want-to-try-cuttlefish">the official README</a>. Cuttlefish uses KVM for performance so your device must support virtualization. See <a href="http://www.linux-kvm.org/page/Processor_support">this page</a> for how to determine that and consult Google for how to enable it in your BIOS if it is not already.</p>
<p>To start, we need to grab a bunch of packages that are essential to this process:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt install -y build-essential devscripts fakeroot git psmisc qemu-kvm unzip zip
</span></span></code></pre></div><p>Next, we will make a folder to contain all of the work we are doing. This can be anywhere but you will need to adjust the rest of the commands for wherever you put it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src
</span></span></code></pre></div><p>After this, we will clone the android-cuttlefish repo locally. This will configure and install some tools that are necessary to boot Cuttlefish. Most of these tools are for development, the main reason to install this package is to get the groups that Cuttlefish needs configured properly. There is also the option of using a Docker image to do this but when I tried to use it, I could not get it to work.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ git clone https://github.com/google/android-cuttlefish <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/android-cuttlefish
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/android-cuttlefish
</span></span></code></pre></div><p>Once the repo has been successfully cloned, we need to install a couple of prerequisite packages specifically for this package we are about to build.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt install -y cdbs config-package-dev debhelper
</span></span></code></pre></div><p>After those have been installed, we will build the package:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ debuild -i -us -uc -b
</span></span></code></pre></div><p>The package should have built successfully. If it did not, see if it says a package is missing or try Googling the error to get it resolved. Once it is built, try to install it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo dpkg -i ../cuttlefish-common_*_amd64.deb
</span></span></code></pre></div><p>That step will fail. The packages that it depends on can be installed along with it by running the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt-get install -f -y
</span></span></code></pre></div><p>Once it gets installed successfully, the <code>cuttlefish-*</code> packages can be removed to avoid cluttering up the workspace.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ rm ../cuttlefish-*
</span></span></code></pre></div><p>After this, we need to add our user to the <code>cvdnetwork</code> and <code>kvm</code> network so that Cuttlefish is allowed to use KVM to boot and configure its network using vsock.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo usermod -aG cvdnetwork <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">$ sudo usermod -aG kvm <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>Once that is done, logout and log back in (or reboot your machine if it is a remote server).</p>
<p>After logging back in, we need to grab prebuilt versions of the Cuttlefish host tools (such as the <code>launch_cvd</code> and <code>stop_cvd</code> commands) as well as the filesystem images, much like a regular Android device, which include <code>super.img</code>, <code>vendor.img</code>, and <code>boot.img</code>. I will show you how to build these from source if you ever want to hack on Cuttlefish later.</p>
<p>We will first create an area for all of this to exist.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/cuttlefish-fs
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/cuttlefish-fs
</span></span></code></pre></div><p>The files we need are all available from <a href="https://ci.android.com">ci.android.com</a>. There will be a LOT of different options, the one we care about is currently the second column: <code>aosp_cf_x86_phone</code>. If you click on the <strong>userdebug</strong> button, it will automatically give you the last known good build. From there, click on the button with the arrow then click on <strong>Artifacts</strong>. The files we need to download are <code>aosp_cf_x86_phone-img-*.zip</code> and <code>cvd-host_package.tar.gz</code>.</p>
<p>This one-liner will grab the zip, unzip it, and remove it. I recommend using the latest, known good build, instead of the one that I have linked here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -LSsO https://ci.android.com/builds/submitted/6173731/aosp_cf_x86_phone-userdebug/latest/aosp_cf_x86_phone-img-6173731.zip <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>unzip *.zip <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>rm *.zip
</span></span></code></pre></div><p>This one-liner will grab the host tools and untar it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -LSs https://ci.android.com/builds/submitted/6173731/aosp_cf_x86_phone-userdebug/latest/cvd-host_package.tar.gz <span class="p">|</span> tar -xzf -
</span></span></code></pre></div><p>Once those have finished downloading, we are ready to run Cuttlefish! We start Cuttlefish using the <code>launch_cvd</code> (Launch Cuttlefish Virtual Device).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/launch_cvd -daemon
</span></span></code></pre></div><p>The <code>HOME=${PWD}</code> is present so that some Cuttlefish runtime files get contained to this folder. The <code>-daemon</code> flag is so that we can interact with Cuttlefish through <code>adb shell</code> in the same terminal window (i.e. it gets sent to the background). You should see a bunch of text fire up then it end with something like:</p>
<pre tabindex="0"><code>run_cvd I 01-31 20:07:50  9571  9571 main.cc:198] VIRTUAL_DEVICE_BOOT_COMPLETED
launch_cvd I 01-31 20:07:50  9543  9543 launch_cvd.cc:131] run_cvd exited successfully.
</code></pre><p>It takes about 20 seconds for Cuttlefish to boot up for me (which is extremely impressive in my opinion). After that, you can run <code>adb</code> to connect to it. You might need to run the command a couple of times so that <code>adb</code> can start and connect to the device but once you do, you should be able to interact with it like any other Android device.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./bin/adb shell
</span></span><span class="line"><span class="cl">vsoc_x86:/ $
</span></span></code></pre></div><p>I like to see what kernel it is running, which at this point is the <code>android-5.4</code> branch, the latest LTS kernel.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vsoc_x86:/ $ cat /proc/version
</span></span><span class="line"><span class="cl">Linux version 5.4.15-gb2b96d09ef40 <span class="o">(</span>android-build@abfarm-01061<span class="o">)</span> <span class="o">(</span>Android <span class="o">(</span><span class="m">6051079</span> based on r370808<span class="o">)</span> clang version 10.0.1 <span class="o">(</span>https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244<span class="o">))</span> <span class="c1">#1 SMP PREEMPT Mon Jan 27 13:04:43 UTC 2020</span>
</span></span></code></pre></div><p>You can see that it actively running tasks by typing in <code>top</code>. Once you are done exploring and want to move on, shutdown this instance by calling <code>stop_cvd</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/stop_cvd
</span></span></code></pre></div><h2 id="2-building-your-own-kernel">2. Building your own kernel<a hidden class="anchor" aria-hidden="true" href="#2-building-your-own-kernel">#</a></h2>
<p>Now that we have gotten Cuttlefish running, it&rsquo;s time to explore one of the main reasons that I use it, which is validating Android kernels. Android has cool technologies in the kernel such as LTO and CFI, which are not currently in mainline. Replacing Cuttlefish&rsquo;s prebuilt kernel is extremely easy, which is one of the main selling points; it makes it really easy for kernel hackers to get involved with it, especially with Google&rsquo;s kernel build system. This section is expanded from <a href="https://source.android.com/setup/build/building-kernels">Google&rsquo;s official documentation</a>.</p>
<p>First, we need to do is grab <code>repo</code>, Google&rsquo;s <code>git</code> management tool. If you already have <code>repo</code> installed, just skip this portion. Alternatively, you can install <code>repo</code> into <code>/usr/local/bin</code> so that it is automatically added to <code>PATH</code> but for the sake of this tutorial, I keep everything localized as much as possible.</p>
<p>Create a <code>bin</code> folder within the Cuttlefish area.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/bin
</span></span></code></pre></div><p>Download <code>repo</code> into the <code>bin</code> folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -LSso <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
</span></span></code></pre></div><p>Make it executable.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ chmod a+x <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/bin/repo
</span></span></code></pre></div><p>Add the <code>bin</code> folder to <code>PATH</code> (NOTE: If you close out of your terminal session or start a new one, you will need to do this everytime):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/cuttlefish-playground/bin:<span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>
</span></span></code></pre></div><p>If you have not already configured <code>git</code> with your email address and your full name, do so now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ git config --global user.email <span class="s2">&#34;you@domain.com&#34;</span>
</span></span><span class="line"><span class="cl">$ git config --global user.name <span class="s2">&#34;Your Name
</span></span></span></code></pre></div><p>After all of this has been configured, we are going to download the kernel source. Depending on your internet speed, this might take some time.</p>
<p>We will create a folder for that source to be saved in. This will also download all of the prebuilt tools we need, such as the compiler and binaries used during the build process.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/kernel-common
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/kernel-common
</span></span></code></pre></div><p>Next, we will download the source. I am using the <code>common-android-mainline</code> branch since it is the latest available and where most of the new development happens but you can use <code>common-android-5.4</code> or <code>common-android-4.19</code> branches if you would like. Any time that you want to get the latest new changes, you can just run <code>repo sync</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ repo init -u https://android.googlesource.com/kernel/manifest -b common-android-mainline
</span></span><span class="line"><span class="cl">$ repo sync
</span></span></code></pre></div><p>Once it is done downloading, we need to make sure that we have the SSL development headers installed, otherwise our build will error out. Google&rsquo;s build is almost heremetic, except for this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt install -y libssl-dev
</span></span></code></pre></div><p>Finally, we are ready to build the kernel. Google&rsquo;s build script takes care of everything as long as we specify a build config, which is <code>build.config.cuttlefish.x86_64</code> in our case. We need to copy the <code>bzImage</code> into the <code>dist</code> folder because Google&rsquo;s <code>build.config.cuttlefish.x86_64</code> is only intended to save the <code>initramfs.img</code>; however, the <code>build.config.gki.x86_64</code> is about to be fully demodularized and we are eventually going to use a different compiler than Google&rsquo;s official one, which will create a mismatch. As a result, we need to do that copy on our own (it isn&rsquo;t strictly necessary, it just makes everything end up in the right spot).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">BUILD_CONFIG</span><span class="o">=</span>common/build.config.cuttlefish.x86_64 ./build/build.sh
</span></span><span class="line"><span class="cl">$ cp out/android-mainline/common/arch/x86/boot/bzImage out/android-mainline/dist/bzImage
</span></span></code></pre></div><p>Once it is done building, we can use that kernel and ramdisk to boot from. <code>launch_cvd</code> has two flags we need to use, <code>-initramfs_path</code> (for the ramdisk that has all of the kernel modules) and <code>-kernel_path</code> for the actual kernel binary. These two files are available in the <code>out/&lt;branch&gt;/dist</code> folder (e.g., <code>out/android-mainline/dist</code>). I would recommend exporting this to a variable that can be easily used later.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">DIST_FOLDER</span><span class="o">=</span><span class="k">$(</span>readlink -f out/android-mainline/dist<span class="k">)</span>
</span></span></code></pre></div><p>Once you do that, we will move back to the <code>cuttlefish-fs</code> folder and use these freshly built files to boot Cuttlefish from:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/cuttlefish-fs
</span></span><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/launch_cvd -daemon -initramfs_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/initramfs.img -kernel_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/bzImage
</span></span></code></pre></div><p>After that, we can use <code>adb shell</code> to see that we indeed used our own kernel since it shows a newer version, different user/hostname, and the repo that we used and that all of the modules properly loaded.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ./bin/adb shell
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ cat /proc/version
</span></span><span class="line"><span class="cl">Linux version 5.5.0-mainline-03266-g1dad8acc36fc <span class="o">(</span>nathan@g2-large-x86<span class="o">)</span> <span class="o">(</span>Android <span class="o">(</span><span class="m">6051079</span> based on r370808<span class="o">)</span> clang version 10.0.1 <span class="o">(</span>https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244<span class="o">))</span> <span class="c1">#1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 21:42:55</span>
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ lsmod
</span></span><span class="line"><span class="cl">Module                  Size  Used by
</span></span><span class="line"><span class="cl">vsock_loopback         <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">vmw_vsock_virtio_transport    <span class="m">24576</span>  <span class="m">3</span>
</span></span><span class="line"><span class="cl">vmw_vsock_virtio_transport_common    <span class="m">36864</span>  <span class="m">2</span> vsock_loopback,vmw_vsock_virtio_transport
</span></span><span class="line"><span class="cl">vsock_diag             <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">vsock                  <span class="m">53248</span>  <span class="m">16</span> vsock_loopback,vmw_vsock_virtio_transport,vmw_vsock_virtio_transport_common,vsock_diag
</span></span><span class="line"><span class="cl">can_raw                <span class="m">20480</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">can                    <span class="m">28672</span>  <span class="m">1</span> can_raw
</span></span><span class="line"><span class="cl">snd_intel8x0           <span class="m">45056</span>  <span class="m">1</span>
</span></span><span class="line"><span class="cl">snd_ac97_codec        <span class="m">229376</span>  <span class="m">1</span> snd_intel8x0
</span></span><span class="line"><span class="cl">ac97_bus               <span class="m">16384</span>  <span class="m">1</span> snd_ac97_codec
</span></span><span class="line"><span class="cl">virtio_input           <span class="m">20480</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_pci             <span class="m">28672</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_mmio            <span class="m">20480</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">gnss_cmdline           <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">gnss_serial            <span class="m">16384</span>  <span class="m">1</span> gnss_cmdline
</span></span><span class="line"><span class="cl">virtio_crypto          <span class="m">28672</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">dummy_cpufreq          <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">rtc_test               <span class="m">16384</span>  <span class="m">1</span>
</span></span><span class="line"><span class="cl">dummy_hcd              <span class="m">32768</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">can_dev                <span class="m">32768</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">vcan                   <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_net             <span class="m">53248</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">net_failover           <span class="m">24576</span>  <span class="m">1</span> virtio_net
</span></span><span class="line"><span class="cl">failover               <span class="m">16384</span>  <span class="m">1</span> net_failover
</span></span><span class="line"><span class="cl">virt_wifi              <span class="m">24576</span>  <span class="m">1</span>
</span></span><span class="line"><span class="cl">virtio_pmem            <span class="m">16384</span>  <span class="m">1</span>
</span></span><span class="line"><span class="cl">nd_virtio              <span class="m">16384</span>  <span class="m">1</span> virtio_pmem
</span></span><span class="line"><span class="cl">virtio_blk             <span class="m">24576</span>  <span class="m">5</span>
</span></span><span class="line"><span class="cl">virtio_gpu             <span class="m">57344</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_console         <span class="m">36864</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_rng             <span class="m">16384</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">virtio_ring            <span class="m">36864</span>  <span class="m">11</span> vmw_vsock_virtio_transport,virtio_input,virtio_pci,virtio_mmio,virtio_crypto,virtio_net,nd_virtio,virtio_blk,virtio_gpu,virtio_console,virtio_rng
</span></span><span class="line"><span class="cl">virtio                 <span class="m">24576</span>  <span class="m">11</span> vmw_vsock_virtio_transport,virtio_input,virtio_pci,virtio_mmio,virtio_crypto,virtio_net,virtio_pmem,virtio_blk,virtio_gpu,virtio_console,virtio_rng
</span></span><span class="line"><span class="cl">blk_mq_virtio          <span class="m">16384</span>  <span class="m">1</span> virtio_blk
</span></span><span class="line"><span class="cl">binfmt_misc            <span class="m">20480</span>  <span class="m">0</span>
</span></span></code></pre></div><p>Once you are done exploring, stop Cuttlefish.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/stop_cvd
</span></span></code></pre></div><h2 id="3-using-upstream-llvm">3. Using upstream LLVM<a hidden class="anchor" aria-hidden="true" href="#3-using-upstream-llvm">#</a></h2>
<p>One of my hobbies is contributing to <a href="https://github.com/ClangBuiltLinux">ClangBuiltLinux</a>, which involves building various Linux kernels with the master version of Clang (11.0.0 at the time of writing this). As a part of that project, I have developed a script that can build a self-contained version of Clang suitable for building kernels. These steps will show you how to build that version of Clang then use it within the Android build system.</p>
<p>First, we need to install some packages that allow us build Clang efficiently (including Clang itself):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt install -y bc bison ccache clang cmake flex libelf-dev lld ninja-build python3 u-boot-tools zlib1g-dev
</span></span></code></pre></div><p>Next, we&rsquo;ll grab the repo that contains the Python script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ git clone git://github.com/ClangBuiltLinux/tc-build <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/tc-build
</span></span></code></pre></div><p>By default, the script does a two stage LLVM build (builds a small version of LLVM then uses that to build a full version of LLVM).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/tc-build/build-llvm.py
</span></span></code></pre></div><p>If for some reason your machine cannot handle that, you can just do a stage 1 build.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/tc-build/build-llvm.py --build-stage1-only --install-stage1-only
</span></span></code></pre></div><p>If you have a machine with good performance, I would recommend using the <code>--pgo</code> flag to build with Profile Guided Optimization; this can result in a 20% speed up when compiling kernels.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/tc-build/build-llvm.py --pgo
</span></span></code></pre></div><p>If for some reason there are any issues using the script, please report them <a href="https://github.com/ClangBuiltLinux/tc-build/issues">here</a> so I can triage them.</p>
<p>Once the toolchain has been built, we will make it available to easily use by symlinking the <code>install</code> folder within <code>tc-build</code> into the <code>prebuilts</code> folder in <code>kernel-common</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ln -s <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/tc-build/install <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/kernel-common/prebuilts-master/clang/host/linux-x86/cbl-clang-master
</span></span></code></pre></div><p>After that, we can use <code>sed</code> to automatically use that Clang when building the kernel.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/kernel-common
</span></span><span class="line"><span class="cl">$ sed -i <span class="s1">&#39;s/clang-r.*/cbl-clang-master\/bin/g&#39;</span> common/build.config.common
</span></span><span class="line"><span class="cl">$ <span class="nv">BUILD_CONFIG</span><span class="o">=</span>common/build.config.cuttlefish.x86_64 ./build/build.sh
</span></span><span class="line"><span class="cl">$ cp out/android-mainline/common/arch/x86/boot/bzImage out/android-mainline/dist/bzImage
</span></span></code></pre></div><p>Once the build is completed, we just use the same commands as before to boot and test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">DIST_FOLDER</span><span class="o">=</span><span class="k">$(</span>readlink -f out/android-mainline/dist<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/cuttlefish-fs
</span></span><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/launch_cvd -daemon -initramfs_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/initramfs.img -kernel_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/bzImage
</span></span><span class="line"><span class="cl">$ ./bin/adb shell
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ cat /proc/version
</span></span><span class="line"><span class="cl">Linux version 5.5.0-mainline-03266-g1dad8acc36fc-dirty <span class="o">(</span>nathan@g2-large-x86<span class="o">)</span> <span class="o">(</span>ClangBuiltLinux clang version 11.0.0 <span class="o">(</span>git://github.com/llvm/llvm-project 64cb77b9469207799e570483dadc720dbf12c794<span class="o">))</span> <span class="c1">#1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 23:47:57</span>
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span> ./bin/stop_cvd
</span></span></code></pre></div><h2 id="4-building-cuttlefish-userspace-from-scratch">4. Building Cuttlefish userspace from scratch<a hidden class="anchor" aria-hidden="true" href="#4-building-cuttlefish-userspace-from-scratch">#</a></h2>
<p>If you want to test the latest and greatest from AOSP&rsquo;s master branch, you can build the things that are in the <code>cuttlefish-fs</code> folder from scratch.</p>
<p>This is not small so make sure that you have room on your hard drive for it. A fresh checkout as of today shows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ diskus .
</span></span><span class="line"><span class="cl">92.68 GB <span class="o">(</span>92,677,562,368 bytes<span class="o">)</span>
</span></span></code></pre></div><p>First, use <code>repo</code> to go and grab the full AOSP source tree.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/aosp
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">&#34;</span>/cuttlefish-playground/src/aosp
</span></span><span class="line"><span class="cl">$ repo init -u https://android.googlesource.com/platform/manifest
</span></span><span class="line"><span class="cl">$ repo sync
</span></span></code></pre></div><p>Next, we need source Android&rsquo;s environment setup script to adjust the PATH variable and add the functions that it uses.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ . build/envsetup.sh
</span></span></code></pre></div><p>After that, we need to use the <code>lunch</code> command to tell the build system that we want to build Cuttlefish.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ lunch aosp_cf_x86_phone-userdebug
</span></span></code></pre></div><p>Next, we&rsquo;re just going to build the world:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ m
</span></span></code></pre></div><p>This will probably take a while since there are usually around 80,000+ files to build. A clean build on <a href="https://www.packet.com/cloud/servers/g2-large/">g2.large.x86</a> takes about 38 minutes.</p>
<p>Once it is done, you can use the <code>launch_cvd</code> command available in <code>PATH</code> to use the new files you just build. The <code>HOME=</code> assignment should still be used to keep the Cuttlefish runtime files contained but I will keep them in the <code>out</code> folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/out launch_cvd -daemon
</span></span></code></pre></div><p>Once it has booted, you can access with the <code>adb</code> that is in the path.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ adb shell
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ cat /proc/version
</span></span><span class="line"><span class="cl">Linux version 5.4.15-gb2b96d09ef40 <span class="o">(</span>android-build@abfarm-01061<span class="o">)</span> <span class="o">(</span>Android <span class="o">(</span><span class="m">6051079</span> based on r370808<span class="o">)</span> clang version 10.0.1 <span class="o">(</span>https://android.googlesource.com/toolchain/llvm-project b9738d6d99f614c8bf7a3e7c769659b313b88244<span class="o">))</span> <span class="c1">#1 SMP PREEMPT Mon Jan 27 13:04:43 UTC 2020</span>
</span></span></code></pre></div><p>The kernel is still prebuilt but you can use a kernel that you build earlier with this new userspace just like before.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">HOME</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/out launch_cvd -daemon -initramfs_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/initramfs.img -kernel_path <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DIST_FOLDER</span><span class="si">}</span><span class="s2">&#34;</span>/bzImage
</span></span><span class="line"><span class="cl">$ adb shell
</span></span><span class="line"><span class="cl">vsoc_x86:/ $ cat /proc/version
</span></span><span class="line"><span class="cl">Linux version 5.5.0-mainline-03266-g1dad8acc36fc-dirty <span class="o">(</span>nathan@g2-large-x86<span class="o">)</span> <span class="o">(</span>ClangBuiltLinux clang version 11.0.0 <span class="o">(</span>git://github.com/llvm/llvm-project 64cb77b9469207799e570483dadc720dbf12c794<span class="o">))</span> <span class="c1">#1 repo:common-android-mainline SMP PREEMPT Fri Jan 31 23:47:57</span>
</span></span></code></pre></div><h1 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h1>
<p>Hopefully this was informative for you! Some further things to potentially explore are things like <a href="https://github.com/joelagnel/adeb">adeb</a>, which allow you to use tracing tools and other Linux utilities on Android to poke around its internals and try and improve or break things or looking into some of the new cool things they are doing like Apex. If you have any questions or problems, feel free to reach out to me on Twitter or GitHub, both of which are linked on my homepage.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nathanchance.dev/tags/android/">android</a></li>
      <li><a href="https://nathanchance.dev/tags/clang/">clang</a></li>
      <li><a href="https://nathanchance.dev/tags/linux/">linux</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://nathanchance.dev/posts/wsl2-distros-from-lxc-images/">
    <span class="title">« Prev</span>
    <br>
    <span>Creating WSL 2 distributions from LXC images</span>
  </a>
  <a class="next" href="https://nathanchance.dev/posts/wsl2-kernel-clang/">
    <span class="title">Next »</span>
    <br>
    <span>Building the WSL 2 kernel with Clang</span>
  </a>
</nav>


<div class="share-buttons">
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on twitter"
        href="https://twitter.com/intent/tweet/?text=Building%20and%20using%20Cuttlefish&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f&amp;hashtags=android%2cclang%2clinux">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-253.927,424.544c135.939,0 210.268,-112.643 210.268,-210.268c0,-3.218 0,-6.437 -0.153,-9.502c14.406,-10.421 26.973,-23.448 36.935,-38.314c-13.18,5.824 -27.433,9.809 -42.452,11.648c15.326,-9.196 26.973,-23.602 32.49,-40.92c-14.252,8.429 -30.038,14.56 -46.896,17.931c-13.487,-14.406 -32.644,-23.295 -53.946,-23.295c-40.767,0 -73.87,33.104 -73.87,73.87c0,5.824 0.613,11.494 1.992,16.858c-61.456,-3.065 -115.862,-32.49 -152.337,-77.241c-6.284,10.881 -9.962,23.601 -9.962,37.088c0,25.594 13.027,48.276 32.95,61.456c-12.107,-0.307 -23.448,-3.678 -33.41,-9.196l0,0.92c0,35.862 25.441,65.594 59.311,72.49c-6.13,1.686 -12.72,2.606 -19.464,2.606c-4.751,0 -9.348,-0.46 -13.946,-1.38c9.349,29.426 36.628,50.728 68.965,51.341c-25.287,19.771 -57.164,31.571 -91.8,31.571c-5.977,0 -11.801,-0.306 -17.625,-1.073c32.337,21.15 71.264,33.41 112.95,33.41Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on linkedin"
        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f&amp;title=Building%20and%20using%20Cuttlefish&amp;summary=Building%20and%20using%20Cuttlefish&amp;source=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on reddit"
        href="https://reddit.com/submit?url=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f&title=Building%20and%20using%20Cuttlefish">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on facebook"
        href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on whatsapp"
        href="https://api.whatsapp.com/send?text=Building%20and%20using%20Cuttlefish%20-%20https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f">
        <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
            <path
                d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
        </svg>
    </a>
    <a target="_blank" rel="noopener noreferrer" aria-label="share Building and using Cuttlefish on telegram"
        href="https://telegram.me/share/url?text=Building%20and%20using%20Cuttlefish&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbuilding-using-cuttlefish%2f">
        <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
            <path
                d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
        </svg>
    </a>
</div>
  </footer><div id="disqus_thread"></div>
<script>
    

    

    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://nathanchance.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://nathanchance.dev/">Nathan Chancellor</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
