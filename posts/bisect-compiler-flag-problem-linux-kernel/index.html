<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Bisecting a Linux Kernel boot failure due to changed compiler flags | Nathan Chancellor</title>
<meta name="keywords" content="">
<meta name="description" content="Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the &ldquo;negative&rdquo; version of it) to try and figure out the exact translation unit and function that causes the problem.">
<meta name="author" content="Nathan Chancellor">
<link rel="canonical" href="https://nathanchance.dev/posts/bisect-compiler-flag-problem-linux-kernel/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e087fd1dc76e73a35ae6d7028ddc1ba41e0131e7f9b3a6e2d019a208e6d6c4b5.css" integrity="sha256-4If9Hcduc6Na5tcCjdwbpB4BMef5s6bi0BmiCObWxLU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://nathanchance.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nathanchance.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nathanchance.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nathanchance.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://nathanchance.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Bisecting a Linux Kernel boot failure due to changed compiler flags" />
<meta property="og:description" content="Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the &ldquo;negative&rdquo; version of it) to try and figure out the exact translation unit and function that causes the problem." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nathanchance.dev/posts/bisect-compiler-flag-problem-linux-kernel/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-28T14:21:18-07:00" />
<meta property="article:modified_time" content="2022-04-28T14:21:18-07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bisecting a Linux Kernel boot failure due to changed compiler flags"/>
<meta name="twitter:description" content="Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the &ldquo;negative&rdquo; version of it) to try and figure out the exact translation unit and function that causes the problem."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nathanchance.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Bisecting a Linux Kernel boot failure due to changed compiler flags",
      "item": "https://nathanchance.dev/posts/bisect-compiler-flag-problem-linux-kernel/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Bisecting a Linux Kernel boot failure due to changed compiler flags",
  "name": "Bisecting a Linux Kernel boot failure due to changed compiler flags",
  "description": "Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the \u0026ldquo;negative\u0026rdquo; version of it) to try and figure out the exact translation unit and function that causes the problem.",
  "keywords": [
    
  ],
  "articleBody": "Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the “negative” version of it) to try and figure out the exact translation unit and function that causes the problem. I’ll go over this process at a high level to help others who might encounter this same issue.\nI will honest up front, this process is not super clean cut; there is some “feel” about it, but I will do my best to explain that right up front. If any of this is confusing, please let me know where you were confused and I will do my best to clarify in this post for future travellers.\n1. Figure out what flag is causing the issue Hopefully you are not making multiple code generation flag changes at once ;) but if you are, you need to figure out which flag is causing the problem.\nThe whole preface of this blog post came from the ClangBuiltLinux issue INIT_STACK_ALL_ZERO - Framework Laptop system freezes (kernel oops?) on boot. The reporter already figured out that CONFIG_INIT_STACK_ALL_ZERO was responsible for the change, which we can see in the main kernel Makefile corresponds to -ftrivial-auto-var-init=zero:\n$ sed -n '826,832p' Makefile ifdef CONFIG_INIT_STACK_ALL_ZERO KBUILD_CFLAGS += -ftrivial-auto-var-init=zero ifdef CONFIG_CC_IS_CLANG # https://bugs.llvm.org/show_bug.cgi?id=45497 KBUILD_CFLAGS += -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang endif endif 2. Figure out if there is a “negative” flag Once the problematic flag has been uncovered, we want to know if the flag has a “negative” version; in other words, we want to know if there is a flag to turn off the problematic flag. In the case of -ftrivial-auto-var-init=zero, we can go to Clang’s cpmmand line reference and see that the default of -ftrivial-auto-var-init= is uninitialized, which means that -ftrivial-auto-var-init=uninitialized will “undo” -ftrivial-auto-var-init=zero. This allows us to append -ftrivial-auto-var-init=uninitialized to certain files to see if the issue disappears, which will allow us to discover the translation unit that has the issue.\nIf there is not a negative flag, you will have to resort to removing the flag from folders and translation units, which is possible, but I am not going to cover that in this post.\n3. Strategically start adding negative flag to translation units The Linux kernel’s build system (Kbuild) allows one to include flags for individual translation units (.o) and entire folders. You can read about the details of each in the Linux Kernel Makefiles documentation. First, we will use subdir-ccflags-y to add the negative flag to entire subfolders then slowly work towards individual flags. Picking the folder or folders that we start in is one of the hardest parts of this process, as it is not the same every single time.\nTo start, it is pretty safe to start with arch//Kbuild and mm/Makefile, as that is all code that runs early in boot, which would look like:\ndiff --git a/arch/x86/Kbuild b/arch/x86/Kbuild index 5a83da703e87..4bb2323eba7c 100644 --- a/arch/x86/Kbuild +++ b/arch/x86/Kbuild @@ -30,3 +30,5 @@ obj-$(CONFIG_KEXEC_FILE) += purgatory/ # for cleaning subdir- += boot tools + +subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized diff --git a/mm/Makefile b/mm/Makefile index 4cc13f3179a5..30717aad76de 100644 --- a/mm/Makefile +++ b/mm/Makefile @@ -3,6 +3,8 @@ # Makefile for the linux memory manager. # +subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized + KASAN_SANITIZE_slab_common.o := n KASAN_SANITIZE_slab.o := n KASAN_SANITIZE_slub.o := n If the issue is resolved with this diff, we have a known good kernel and a known bad kernel, which means it is possible to do further bisection. If the issue is not resolved, it means that these folders do not have the code responsible for the issue. The next place I would start is somewhere in drivers/, as it is possible that a driver problem can cause issues with the device fully starting up. For example, a problem in drivers/gpu/drm might result in no graphical output:\ndiff --git a/drivers/gpu/drm/Makefile b/drivers/gpu/drm/Makefile index c2ef5f9fce54..a3ed2f48fa84 100644 --- a/drivers/gpu/drm/Makefile +++ b/drivers/gpu/drm/Makefile @@ -3,6 +3,8 @@ # Makefile for the drm device driver. This driver provides support for the # Direct Rendering Infrastructure (DRI) in XFree86 4.1.0 and higher. +subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized + drm-y := drm_aperture.o drm_auth.o drm_cache.o \\ drm_file.o drm_gem.o drm_ioctl.o \\ drm_drv.o \\ 4. Start moving down the folder that is problematic At this point, you will want to try and narrow the problem down to one top level folder (such as arch/, drivers, or mm) so that you can focus on moving down the directory structure quickly.\nOnce you have the folder (I’ll be using arch/x86 as an example), you will want to find all the Makefiles that are directly below where you started. For example, in arch/x86:\n$ fd -d 2 Makefile arch/x86 arch/x86/Makefile arch/x86/Makefile.um arch/x86/Makefile_32.cpu arch/x86/boot/Makefile arch/x86/coco/Makefile arch/x86/crypto/Makefile arch/x86/entry/Makefile arch/x86/events/Makefile arch/x86/hyperv/Makefile arch/x86/ia32/Makefile arch/x86/kernel/Makefile arch/x86/kvm/Makefile arch/x86/lib/Makefile arch/x86/math-emu/Makefile arch/x86/mm/Makefile arch/x86/net/Makefile arch/x86/pci/Makefile arch/x86/platform/Makefile arch/x86/power/Makefile arch/x86/purgatory/Makefile arch/x86/realmode/Makefile arch/x86/tools/Makefile arch/x86/um/Makefile arch/x86/video/Makefile arch/x86/xen/Makefile We want to remove the original subdir-ccflags-y from the higher Makefile and move it down into the individual Makefiles. Once that is done, boot your kernel to make sure the issue is still fixed, as it should be.\nOnce that is done, remove the addition to half of the Makefile and see if the issue is resolved. If it is, we know the issue is in the folders that still have the negative flag. If it is not, we know the issue is in the folders that we just removed the negative flag from. From there, move the flags further and further down until you arrive at a folder with no subdirectories. I would recommend committing your changes via git, as that will make it easier to verify what kernel you are testing and undoing changes is much easier.\n5. Bisect individual translation units Once you have arrived at a folder with just Makefile and some .c files, you are ready to figure out the problematic translation unit (or units!).\nRemove any subdir-ccflags-y that you have added. We need to generate a set of CFLAGS for the individual translation units to test. Assuming you stil have the object files from your previous build, you can generate this using a shell command such as:\n$ for file in /*.o; do echo CFLAGS_$(basename \"$file\") := done \u003e\u003e/Makefile For example, if I were testing mm/:\n$ for file in mm/*.o; do echo CFLAGS_$(basename \"$file\") := done \u003e\u003emm/Makefile At this point, make sure the issue is still fixed. If it is, do the same process as above by either deleting or commenting out the flags and seeing if the issue is still resolved. If it is, the issue is in one of the files that still has the flags applied. If the issue comes back, you know the issue is in one of the files that just had the flag removed. Repeat this process until you are left with a minimal set of files that does not have the issue.\n6. Bisect individual functions Once there is a set of translation units, it might be possible to further narrow down what function causes the problem using function or variable attributes. By this point, it might be obvious why there is a problem but if not, you will basically apply the attribute to the types that need it and do a similar process.\nIn the case of -ftrivial-auto-var-init=uninitialized, there is __attribute((uninitialized)), which can be applied to local variables, such as:\ndiff --git a/mm/hmm.c b/mm/hmm.c index 3fd3242c5e50..54f53bbe3632 100644 --- a/mm/hmm.c +++ b/mm/hmm.c @@ -235,7 +235,7 @@ static int hmm_vma_handle_pte(struct mm_walk *walk, unsigned long addr, struct hmm_vma_walk *hmm_vma_walk = walk-\u003eprivate; struct hmm_range *range = hmm_vma_walk-\u003erange; unsigned int required_fault; - unsigned long cpu_flags; + __attribute((uninitialized)) unsigned long cpu_flags; pte_t pte = *ptep; uint64_t pfn_req_flags = *hmm_pfn; From there, do the same process of applying the attribute, testing, and removing until you are left with a single set of variables. After that, analysis can commence.\nComments If you have any problems or need help, feel free to comment down below or reach out to me via email or Twitter! I will do my best to keep this post up to date over time.\n",
  "wordCount" : "1362",
  "inLanguage": "en",
  "datePublished": "2022-04-28T14:21:18-07:00",
  "dateModified": "2022-04-28T14:21:18-07:00",
  "author":{
    "@type": "Person",
    "name": "Nathan Chancellor"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nathanchance.dev/posts/bisect-compiler-flag-problem-linux-kernel/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nathan Chancellor",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nathanchance.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nathanchance.dev/" accesskey="h" title="Nathan Chancellor (Alt + H)">Nathan Chancellor</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nathanchance.dev/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/nc_resume.pdf" title="Resume">
                    <span>Resume</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/downloads/" title="Downloads">
                    <span>Downloads</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Bisecting a Linux Kernel boot failure due to changed compiler flags
    </h1>
    <div class="post-meta"><span title='2022-04-28 14:21:18 -0700 MST'>April 28, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Nathan Chancellor&nbsp;|&nbsp;<a href="https://github.com/nathanchance/hugo-files/blob/main/content/posts/bisect-compiler-flag-problem-linux-kernel.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-figure-out-what-flag-is-causing-the-issue" aria-label="1. Figure out what flag is causing the issue">1. Figure out what flag is causing the issue</a></li>
                <li>
                    <a href="#2-figure-out-if-there-is-a-negative-flag" aria-label="2. Figure out if there is a &ldquo;negative&rdquo; flag">2. Figure out if there is a &ldquo;negative&rdquo; flag</a></li>
                <li>
                    <a href="#3-strategically-start-adding-negative-flag-to-translation-units" aria-label="3. Strategically start adding negative flag to translation units">3. Strategically start adding negative flag to translation units</a></li>
                <li>
                    <a href="#4-start-moving-down-the-folder-that-is-problematic" aria-label="4. Start moving down the folder that is problematic">4. Start moving down the folder that is problematic</a></li>
                <li>
                    <a href="#5-bisect-individual-translation-units" aria-label="5. Bisect individual translation units">5. Bisect individual translation units</a></li>
                <li>
                    <a href="#6-bisect-individual-functions" aria-label="6. Bisect individual functions">6. Bisect individual functions</a></li>
                <li>
                    <a href="#comments" aria-label="Comments">Comments</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Occasionally, compiling the Linux kernel with a new compiler flag will result in a boot failure. If you are lucky, there will be some output to the serial console but that may not happen if the issue happens in early boot code before the serial driver has loaded. When this happens, it usually requires building part of the kernel without the compiler flag (or the &ldquo;negative&rdquo; version of it) to try and figure out the exact translation unit and function that causes the problem. I&rsquo;ll go over this process at a high level to help others who might encounter this same issue.</p>
<p>I will honest up front, this process is not super clean cut; there is some &ldquo;feel&rdquo; about it, but I will do my best to explain that right up front. If any of this is confusing, please let me know where you were confused and I will do my best to clarify in this post for future travellers.</p>
<h2 id="1-figure-out-what-flag-is-causing-the-issue">1. Figure out what flag is causing the issue<a hidden class="anchor" aria-hidden="true" href="#1-figure-out-what-flag-is-causing-the-issue">#</a></h2>
<p>Hopefully you are not making multiple code generation flag changes at once ;) but if you are, you need to figure out which flag is causing the problem.</p>
<p>The whole preface of this blog post came from the ClangBuiltLinux issue <a href="https://github.com/ClangBuiltLinux/linux/issues/1626">INIT_STACK_ALL_ZERO - Framework Laptop system freezes (kernel oops?) on boot</a>. The reporter already figured out that <code>CONFIG_INIT_STACK_ALL_ZERO</code> was responsible for the change, which we can see in the main kernel <code>Makefile</code> corresponds to <code>-ftrivial-auto-var-init=zero</code>:</p>
<pre tabindex="0"><code>$ sed -n &#39;826,832p&#39; Makefile
ifdef CONFIG_INIT_STACK_ALL_ZERO
KBUILD_CFLAGS   += -ftrivial-auto-var-init=zero
ifdef CONFIG_CC_IS_CLANG
# https://bugs.llvm.org/show_bug.cgi?id=45497
KBUILD_CFLAGS   += -enable-trivial-auto-var-init-zero-knowing-it-will-be-removed-from-clang
endif
endif
</code></pre><h2 id="2-figure-out-if-there-is-a-negative-flag">2. Figure out if there is a &ldquo;negative&rdquo; flag<a hidden class="anchor" aria-hidden="true" href="#2-figure-out-if-there-is-a-negative-flag">#</a></h2>
<p>Once the problematic flag has been uncovered, we want to know if the flag has a &ldquo;negative&rdquo; version; in other words, we want to know if there is a flag to turn off the problematic flag. In the case of <code>-ftrivial-auto-var-init=zero</code>, we can go to <a href="https://clang.llvm.org/docs/ClangCommandLineReference.html#cmdoption-clang-ftrivial-auto-var-init">Clang&rsquo;s cpmmand line reference</a> and see that the default of <code>-ftrivial-auto-var-init=</code> is <code>uninitialized</code>, which means that <code>-ftrivial-auto-var-init=uninitialized</code> will &ldquo;undo&rdquo; <code>-ftrivial-auto-var-init=zero</code>. This allows us to append <code>-ftrivial-auto-var-init=uninitialized</code> to certain files to see if the issue disappears, which will allow us to discover the translation unit that has the issue.</p>
<p>If there is not a negative flag, you will have to resort to removing the flag from folders and translation units, which is possible, but I am not going to cover that in this post.</p>
<h2 id="3-strategically-start-adding-negative-flag-to-translation-units">3. Strategically start adding negative flag to translation units<a hidden class="anchor" aria-hidden="true" href="#3-strategically-start-adding-negative-flag-to-translation-units">#</a></h2>
<p>The Linux kernel&rsquo;s build system (Kbuild) allows one to include flags for individual translation units (<code>.o</code>) and entire folders. You can read about the details of each in the <a href="https://www.kernel.org/doc/html/latest/kbuild/makefiles.html#compilation-flags">Linux Kernel Makefiles documentation</a>. First, we will use <code>subdir-ccflags-y</code> to add the negative flag to entire subfolders then slowly work towards individual flags. Picking the folder or folders that we start in is one of the hardest parts of this process, as it is not the same every single time.</p>
<p>To start, it is pretty safe to start with <code>arch/&lt;your_architecture&gt;/Kbuild</code> and <code>mm/Makefile</code>, as that is all code that runs early in boot, which would look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/arch/x86/Kbuild b/arch/x86/Kbuild
</span></span></span><span class="line"><span class="cl"><span class="gh">index 5a83da703e87..4bb2323eba7c 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/arch/x86/Kbuild
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/arch/x86/Kbuild
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -30,3 +30,5 @@ obj-$(CONFIG_KEXEC_FILE) += purgatory/
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>
</span></span><span class="line"><span class="cl"> # for cleaning
</span></span><span class="line"><span class="cl"> subdir- += boot tools
</span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gh">diff --git a/mm/Makefile b/mm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gh">index 4cc13f3179a5..30717aad76de 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/mm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/mm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -3,6 +3,8 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> # Makefile for the linux memory manager.
</span></span><span class="line"><span class="cl"> #
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> KASAN_SANITIZE_slab_common.o := n
</span></span><span class="line"><span class="cl"> KASAN_SANITIZE_slab.o := n
</span></span><span class="line"><span class="cl"> KASAN_SANITIZE_slub.o := n
</span></span></code></pre></div><p>If the issue is resolved with this diff, we have a known good kernel and a known bad kernel, which means it is possible to do further bisection. If the issue is not resolved, it means that these folders do not have the code responsible for the issue. The next place I would start is somewhere in <code>drivers/</code>, as it is possible that a driver problem can cause issues with the device fully starting up. For example, a problem in <code>drivers/gpu/drm</code> might result in no graphical output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/drivers/gpu/drm/Makefile b/drivers/gpu/drm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gh">index c2ef5f9fce54..a3ed2f48fa84 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/drivers/gpu/drm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/drivers/gpu/drm/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -3,6 +3,8 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> # Makefile for the drm device driver.  This driver provides support for the
</span></span><span class="line"><span class="cl"> # Direct Rendering Infrastructure (DRI) in XFree86 4.1.0 and higher.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+subdir-ccflags-y := -ftrivial-auto-var-init=uninitialized
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> drm-y       := drm_aperture.o drm_auth.o drm_cache.o \
</span></span><span class="line"><span class="cl">                drm_file.o drm_gem.o drm_ioctl.o \
</span></span><span class="line"><span class="cl">                drm_drv.o \
</span></span></code></pre></div><h2 id="4-start-moving-down-the-folder-that-is-problematic">4. Start moving down the folder that is problematic<a hidden class="anchor" aria-hidden="true" href="#4-start-moving-down-the-folder-that-is-problematic">#</a></h2>
<p>At this point, you will want to try and narrow the problem down to one top level folder (such as <code>arch/&lt;your_architecture&gt;</code>, <code>drivers</code>, or <code>mm</code>) so that you can focus on moving down the directory structure quickly.</p>
<p>Once you have the folder (I&rsquo;ll be using <code>arch/x86</code> as an example), you will want to find all the <code>Makefile</code>s that are directly below where you started. For example, in <code>arch/x86</code>:</p>
<pre tabindex="0"><code>$ fd -d 2 Makefile arch/x86
arch/x86/Makefile
arch/x86/Makefile.um
arch/x86/Makefile_32.cpu
arch/x86/boot/Makefile
arch/x86/coco/Makefile
arch/x86/crypto/Makefile
arch/x86/entry/Makefile
arch/x86/events/Makefile
arch/x86/hyperv/Makefile
arch/x86/ia32/Makefile
arch/x86/kernel/Makefile
arch/x86/kvm/Makefile
arch/x86/lib/Makefile
arch/x86/math-emu/Makefile
arch/x86/mm/Makefile
arch/x86/net/Makefile
arch/x86/pci/Makefile
arch/x86/platform/Makefile
arch/x86/power/Makefile
arch/x86/purgatory/Makefile
arch/x86/realmode/Makefile
arch/x86/tools/Makefile
arch/x86/um/Makefile
arch/x86/video/Makefile
arch/x86/xen/Makefile
</code></pre><p>We want to remove the original <code>subdir-ccflags-y</code> from the higher <code>Makefile</code> and move it down into the individual <code>Makefile</code>s. Once that is done, boot your kernel to make sure the issue is still fixed, as it should be.</p>
<p>Once that is done, remove the addition to half of the Makefile and see if the issue is resolved. If it is, we know the issue is in the folders that still have the negative flag. If it is not, we know the issue is in the folders that we just removed the negative flag from. From there, move the flags further and further down until you arrive at a folder with no subdirectories. I would recommend committing your changes via <code>git</code>, as that will make it easier to verify what kernel you are testing and undoing changes is much easier.</p>
<h2 id="5-bisect-individual-translation-units">5. Bisect individual translation units<a hidden class="anchor" aria-hidden="true" href="#5-bisect-individual-translation-units">#</a></h2>
<p>Once you have arrived at a folder with just <code>Makefile</code> and some <code>.c</code> files, you are ready to figure out the problematic translation unit (or units!).</p>
<p>Remove any <code>subdir-ccflags-y</code> that you have added. We need to generate a set of <code>CFLAGS</code> for the individual translation units to test. Assuming you stil have the object files from your previous build, you can generate this using a shell command such as:</p>
<pre tabindex="0"><code>$ for file in &lt;subdir&gt;/*.o; do
echo CFLAGS_$(basename &#34;$file&#34;) := &lt;negative_flag&gt;
done &gt;&gt;&lt;subdir&gt;/Makefile
</code></pre><p>For example, if I were testing <code>mm/</code>:</p>
<pre tabindex="0"><code>$ for file in mm/*.o; do
echo CFLAGS_$(basename &#34;$file&#34;) := &lt;negative_flag&gt;
done &gt;&gt;mm/Makefile
</code></pre><p>At this point, make sure the issue is still fixed. If it is, do the same process as above by either deleting or commenting out the flags and seeing if the issue is still resolved. If it is, the issue is in one of the files that still has the flags applied. If the issue comes back, you know the issue is in one of the files that just had the flag removed. Repeat this process until you are left with a minimal set of files that does not have the issue.</p>
<h2 id="6-bisect-individual-functions">6. Bisect individual functions<a hidden class="anchor" aria-hidden="true" href="#6-bisect-individual-functions">#</a></h2>
<p>Once there is a set of translation units, it might be possible to further narrow down what function causes the problem using function or variable attributes. By this point, it might be obvious why there is a problem but if not, you will basically apply the attribute to the types that need it and do a similar process.</p>
<p>In the case of <code>-ftrivial-auto-var-init=uninitialized</code>, there is <code>__attribute((uninitialized))</code>, which can be applied to local variables, such as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/mm/hmm.c b/mm/hmm.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 3fd3242c5e50..54f53bbe3632 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/mm/hmm.c
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/mm/hmm.c
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -235,7 +235,7 @@ static int hmm_vma_handle_pte(struct mm_walk *walk, unsigned long addr,
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        struct hmm_vma_walk *hmm_vma_walk = walk-&gt;private;
</span></span><span class="line"><span class="cl">        struct hmm_range *range = hmm_vma_walk-&gt;range;
</span></span><span class="line"><span class="cl">        unsigned int required_fault;
</span></span><span class="line"><span class="cl"><span class="gd">-       unsigned long cpu_flags;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+       __attribute((uninitialized)) unsigned long cpu_flags;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        pte_t pte = *ptep;
</span></span><span class="line"><span class="cl">        uint64_t pfn_req_flags = *hmm_pfn;
</span></span></code></pre></div><p>From there, do the same process of applying the attribute, testing, and removing until you are left with a single set of variables. After that, analysis can commence.</p>
<h2 id="comments">Comments<a hidden class="anchor" aria-hidden="true" href="#comments">#</a></h2>
<p>If you have any problems or need help, feel free to comment down below or reach out to me via <a href="mailto:nathan@kernel.org">email</a> or <a href="https://twitter.com/nathanchance">Twitter</a>! I will do my best to keep this post up to date over time.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://nathanchance.dev/posts/april-2022-cbl-work/">
    <span class="title">« Prev</span>
    <br>
    <span>April 2022 ClangBuiltLinux Work</span>
  </a>
  <a class="next" href="https://nathanchance.dev/posts/package-standalone-linux-kernel-with-abs/">
    <span class="title">Next »</span>
    <br>
    <span>Package a standalone Linux kernel using the Arch Linux Build System</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on x"
            href="https://x.com/intent/tweet/?text=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f&amp;title=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags&amp;summary=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags&amp;source=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f&title=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on whatsapp"
            href="https://api.whatsapp.com/send?text=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags%20-%20https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on telegram"
            href="https://telegram.me/share/url?text=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Bisecting a Linux Kernel boot failure due to changed compiler flags on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Bisecting%20a%20Linux%20Kernel%20boot%20failure%20due%20to%20changed%20compiler%20flags&u=https%3a%2f%2fnathanchance.dev%2fposts%2fbisect-compiler-flag-problem-linux-kernel%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div id="disqus_thread"></div>
<script>
    

    

    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://nathanchance.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://nathanchance.dev/">Nathan Chancellor</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
