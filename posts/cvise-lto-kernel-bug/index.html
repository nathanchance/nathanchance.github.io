<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Reducing an LTO Linux kernel bug with cvise | Nathan Chancellor</title>
<meta name="keywords" content="clang, clangbuiltlinux, linux, llvm, lto">
<meta name="description" content="My co-maintainer Nick Desaulniers wrote a great post about taking a several thousand line C file that exposed a compiler bug down to 12 lines with creduce. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.">
<meta name="author" content="Nathan Chancellor">
<link rel="canonical" href="https://nathanchance.dev/posts/cvise-lto-kernel-bug/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://nathanchance.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://nathanchance.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://nathanchance.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://nathanchance.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://nathanchance.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://nathanchance.dev/posts/cvise-lto-kernel-bug/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://nathanchance.dev/posts/cvise-lto-kernel-bug/">
  <meta property="og:site_name" content="Nathan Chancellor">
  <meta property="og:title" content="Reducing an LTO Linux kernel bug with cvise">
  <meta property="og:description" content="My co-maintainer Nick Desaulniers wrote a great post about taking a several thousand line C file that exposed a compiler bug down to 12 lines with creduce. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-11-29T10:07:16-07:00">
    <meta property="article:modified_time" content="2021-11-29T10:07:16-07:00">
    <meta property="article:tag" content="Clang">
    <meta property="article:tag" content="Clangbuiltlinux">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Llvm">
    <meta property="article:tag" content="Lto">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Reducing an LTO Linux kernel bug with cvise">
<meta name="twitter:description" content="My co-maintainer Nick Desaulniers wrote a great post about taking a several thousand line C file that exposed a compiler bug down to 12 lines with creduce. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://nathanchance.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Reducing an LTO Linux kernel bug with cvise",
      "item": "https://nathanchance.dev/posts/cvise-lto-kernel-bug/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Reducing an LTO Linux kernel bug with cvise",
  "name": "Reducing an LTO Linux kernel bug with cvise",
  "description": "My co-maintainer Nick Desaulniers wrote a great post about taking a several thousand line C file that exposed a compiler bug down to 12 lines with creduce. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.\n",
  "keywords": [
    "clang", "clangbuiltlinux", "linux", "llvm", "lto"
  ],
  "articleBody": "My co-maintainer Nick Desaulniers wrote a great post about taking a several thousand line C file that exposed a compiler bug down to 12 lines with creduce. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.\nMake sure the bug is reproducible Any time that I receive a bug report on our GitHub issue tracker, I want to make sure it is reproducible for me so that I can investigate it in my environment with my tools. The report in question is issue #1215 and issue #1516. The second issue has a set of configurations that trigger the issue with either ARCH=x86_64 or ARCH=arm64; as I am working on an x86_64 server, it is probably going to be easier to work with the native architecture.\nI like to use tuxmake for initially reproducing bugs with Debian clang versions, as they are prepacked in Docker images. I won’t get into the specifics of how to use tuxmake in this post, its documentation is pretty good as it is and I am only going to use it for initially reproducing the issue. The reporter of issue #1516 mentions they are using the latest stable branch (linux-5.15.y) but I want to reproduce on mainline, as that is going to change how I approach this bug. If the bug is fixed on mainline and broken on stable, it means there was a fix somewhere that needs to be found and backported, which is much simpler than fixing an issue that is still present in the development tree.\n$ git show -s commit d58071a8a76d779eedab38033ae4c821c30295a5 (HEAD, tag: v5.16-rc3, origin/master) Author: Linus Torvalds Date: Sun Nov 28 14:09:19 2021 -0800 Linux 5.16-rc3 $ echo \"CONFIG_FTRACE_MCOUNT_USE_RECORDMCOUNT=n CONFIG_KASAN=n CONFIG_GCOV_KERNEL=n CONFIG_COMPILE_TEST=n CONFIG_LTO_CLANG_FULL=y CONFIG_TRIM_UNUSED_KSYMS=y CONFIG_CFI_CLANG=y CONFIG_CFI_CLANG_SHADOW=y CONFIG_SHADOW_CALL_STACK=y CONFIG_INIT_STACK_ALL_ZERO=y\" \u003ekernel/configs/repro.config $ tuxmake \\ -a x86_64 \\ -k allmodconfig \\ -K repro.config \\ -r podman \\ -t clang-13 \\ LLVM=1 LLVM_IAS=1 default ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM13.0.1' Reader: 'LLVM 13.0.1') make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1 ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM13.0.1' Reader: 'LLVM 13.0.1') make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1 ... Okay, so the bug is reproducible locally. Now, I know that some of these configuration options are not needed to reproduce the issue. CONFIG_CFI_CLANG and CONFIG_CFI_CLANG_SHADOW do not currently work for x86_64. CONFIG_SHADOW_CALL_STACK is an arm64 only feature. CONFIG_FTRACE_MCOUNT_USE_RECORDMCOUNT is not a user selectable Kconfig value (it is just bool, rather than bool \"...\"). CONFIG_INIT_STACK_ALL_ZERO and CONFIG_TRIM_UNUSED_KSYMS are a little suspect but let’s see if we can reproduce this bug without them to keep our scope more limited (fewer variables can make the bug easier to fix down the road).\nCONFIG_LTO_CLANG_FULL appears critical to the problem and CONFIG_KASAN, CONFIG_GCOV_KERNEL, and CONFIG_COMPILE_TEST all need to be disabled for it to be selected. So:\n$ echo \"CONFIG_COMPILE_TEST=n CONFIG_GCOV_KERNEL=n CONFIG_KASAN=n CONFIG_LTO_CLANG_FULL=y\" \u003ekernel/configs/repro.config $ tuxmake \\ -a x86_64 \\ -k allmodconfig \\ -K repro.config \\ -r podman \\ -t clang-13 \\ LLVM=1 LLVM_IAS=1 default ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM13.0.1' Reader: 'LLVM 13.0.1') make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1 ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM13.0.1' Reader: 'LLVM 13.0.1') make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1 ... I: config: PASS in 0:00:07.230375 I: default: FAIL in 0:09:36.347980 I: build output in /home/nathan/.cache/tuxmake/builds/273 Alright, we have a decently minimal configuration (allmodconfig with full LTO) to work off of. Take note of the .../.cache/tuxmake/builds/273, that will come in handy later.\nReproduce the bug with the latest compiler We reproduced the bug with the latest Linux kernel development release but we used a released version of clang (13). For the same reason as above, we want to make sure the bug is not already fixed with the development branch, as duplicate reports waste developers’ time. apt.llvm.org is a great resource for quickly getting access to a close to tip of tree clang to test with, if you are on Debian/Ubuntu or willing to work out of a Docker image. For the purpose of this tutorial, we are just going to build it from source. I developed a Python LLVM build script (build-llvm.py) as part of tc-build to help with situations like this.\nI will explain the flags below:\n--build-folder/--llvm-folder: By default, the script keeps everything self-contained; it builds the toolchain in build/ and it downloads the source to llvm-project/. I have a separate tree that I use for development so I provide these flags to point those folders to that tree. These will not be necessary under normal circumstances. --assertions: Turns on assertions in the LLVM source, which can help figure out the cause of the bug sooner, but it will make the compiler slower; it might not be worth the trade off depending on what you are reducing. --build-stage1-only: Shortens the build time, as the script normally builds a compiler and uses that compiler to build the final compiler (a two stage build). When using the toolchain for more than a triage, this should be omitted, as a two stage build can produce a more optimized compiler. --check-targets: Runs the check targets requested (clang will become check-clang) to make sure there are no current obvious issues with the development tree. --projects: Limits what we build to clang and ld.lld, as we do not need any other projects to reproduce this. --targets: Limits the available backends to just X86, which is the only one we need to reproduce the issue, to help speed up the build. $ $CBL_GIT/tc-build/build-llvm.py \\ --assertions \\ --build-folder $CBL_SRC/llvm-project/build \\ --build-stage1-only \\ --check-targets clang ll{d,vm{,-unit}} \\ --llvm-folder $CBL_SRC/llvm-project \\ --projects \"clang;lld\" \\ --targets X86 ... LLVM build duration: 0:06:02 LLVM toolchain installed to: /home/nathan/cbl/src/llvm-project/build/stage1 To use, either run: $ export PATH=/home/nathan/cbl/src/llvm-project/build/stage1/bin:${PATH} or add: PATH=/home/nathan/cbl/src/llvm-project/build/stage1/bin:${PATH} to the command you want to use this toolchain. Version information: ClangBuiltLinux clang version 14.0.0 (https://github.com/llvm/llvm-project 8d474f1d157530577f06ce3ef9187e1aaf31a59e) Target: x86_64-unknown-linux-gnu Thread model: posix InstalledDir: /home/nathan/cbl/src/llvm-project/build/stage1/bin LLD 14.0.0 (compatible with GNU linkers) After a little bit of time (or maybe a lot of time, depending on how fast your machine is), the script will spit out some information like above, which explains how we can use it.\nOne nice thing about tuxmake is that it generates a config file that we can use to reproduce issues later (that is why I mentioned taking note of the folder that tuxmake generates at the end). Thus, with the new toolchain and the old config, we can see if the issue is still reproducible:\n$ cp $HOME/.cache/tuxmake/builds/273/config .config $ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \\ make -skj\"$(nproc)\" LLVM=1 LLVM_IAS=1 olddefconfig all ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') make[3]: *** [scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1 ... drivers/gpu/drm/i915/intel_pm.c:3065:12: error: use of bitwise '|' with boolean operands [-Werror,-Wbitwise-instead-of-logical] changed = ilk_increase_wm_latency(dev_priv, dev_priv-\u003ewm.pri_latency, 12) | ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ drivers/gpu/drm/i915/intel_pm.c:3065:12: note: cast one or both operands to int to silence this warning drivers/gpu/drm/i915/intel_pm.c:3065:12: error: use of bitwise '|' with boolean operands [-Werror,-Wbitwise-instead-of-logical] changed = ilk_increase_wm_latency(dev_priv, dev_priv-\u003ewm.pri_latency, 12) | ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ || drivers/gpu/drm/i915/intel_pm.c:3065:12: note: cast one or both operands to int to silence this warning 2 errors generated. ... drivers/power/reset/ltc2952-poweroff.c:162:28: error: expression requires 'long double' type support, but target 'x86_64-unknown-linux-gnu' does not support it data-\u003ewde_interval = 300L * 1E6L; ^ drivers/power/reset/ltc2952-poweroff.c:162:21: error: expression requires 'long double' type support, but target 'x86_64-unknown-linux-gnu' does not support it data-\u003ewde_interval = 300L * 1E6L; ^ drivers/power/reset/ltc2952-poweroff.c:163:41: error: expression requires 'long double' type support, but target 'x86_64-unknown-linux-gnu' does not support it data-\u003etrigger_delay = ktime_set(2, 500L*1E6L); ^ 3 errors generated. ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') make[3]: *** [scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1 ... So the issue reproduces but we picked up a couple new issues by the nature of going to a development build of LLVM. These are not going to impact our triage but it is still good to fix them. Thankfully, patches to fix these issues exist on the mailing list:\n$ curl -LSs https://lore.kernel.org/lkml/20211014211916.3550122-1-nathan@kernel.org/raw | patch -Np1 patching file drivers/gpu/drm/i915/intel_pm.c Hunk #1 succeeded at 3062 (offset 12 lines). $ curl -LSs https://lore.kernel.org/lkml/20211105152049.2522250-1-nathan@kernel.org/raw | patch -Np1 patching file drivers/power/reset/ltc2952-poweroff.c Running the above command again should just show the two errors now.\nReproduce the issue outside of the build system The next step is getting the files that we need to reproduce the issue separated from the build system. We can choose to look at fs/overlayfs/overlay.lto.o or fs/xfs/xfs.lto.o; I am going to choose the former, as fs/overlayfs/ is a smaller directory than fs/xfs/.\nThe Linux kernel’s build system has a variable V=1 to see every build step, which we can dump to a text file for easy inspection and searching. Note: the -s flag needs to be dropped from make to get the full output.\n$ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \\ make -kj\"$(nproc)\" LLVM=1 LLVM_IAS=1 olddefconfig clean all V=1 \u0026\u003ebuild.log First, we need to see how fs/overlayfs/overlay.lto.o is generated.\n$ rg fs/overlayfs/overlay.lto.o build.log 6011: ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/overlay.o ; ./tools/objtool/objtool orc generate --module --no-fp --no-unreachable --retpoline --uaccess --mcount fs/overlayfs/overlay.lto.o 6133:make[3]: *** [scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1 It comes from fs/overlayfs/overlay.o so we need to see how that is generated.\n$ rg fs/overlayfs/overlay.o build.log 29599: rm -f fs/overlayfs/overlay.o.symversions ; rm -f fs/overlayfs/overlay.o; llvm-ar cDPrsT fs/overlayfs/overlay.o fs/overlayfs/super.o fs/overlayfs/namei.o fs/overlayfs/util.o fs/overlayfs/inode.o fs/overlayfs/file.o fs/overlayfs/dir.o fs/overlayfs/readdir.o fs/overlayfs/copy_up.o fs/overlayfs/export.o 29634: ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/overlay.o ; ./tools/objtool/objtool orc generate --module --no-fp --no-unreachable --retpoline --uaccess --mcount fs/overlayfs/overlay.lto.o It comes from running llvm-ar on a bunch of .o files in fs/overlayfs/. Now we need to figure out which .o has the issue. This can be done by running the ld.lld command with a single .o files from the llvm-ar command (llvm-ar is only necessary for combining multiple .o files into one). For example, with fs/overlayfs/super.o:\n$ rm fs/overlayfs/overlay.o $ $CBL_SRC/llvm-project/build/stage1/bin/ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/super.o $ echo $? 0 So the issue is not with fs/overlayfs/super.c. Trying all the other files, we end up seeing the error in fs/overlayfs/file.c:\n$ rm fs/overlayfs/overlay.o $ $CBL_SRC/llvm-project/build/stage1/bin/ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/file.o ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') Okay, we have a single C file that can reproduce the issue, which we can reduce from. The Linux kernel allows us to generate a preprocessed file (.i) from source files (.c) directly, which is important for reduction purposes as it will be one file that can be built anywhere, rather than being tied to a build system and headers. The other thing we need is the build command for the object file (.o) so we know what flags to use for reproducing the issue. The kernel’s build system generates .cmd to show the command used to build the object file but these only show up when the object file can be successfully built. If you are reducing a build error on the object file, you can use the V=1 trick above to see the command. So, putting that all together:\n# Generate the '.i' and '.o' files $ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \\ make -kj\"$(nproc)\" LLVM=1 LLVM_IAS=1 olddefconfig clean fs/overlayfs/file.{i,o} # Get the compiler command from the .cmd file $ head -1 fs/overlayfs/.file.o.cmd cmd_fs/overlayfs/file.o := clang -Wp,-MMD,fs/overlayfs/.file.o.d -nostdinc -I./arch/x86/include -I./arch/x86/include/generated -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -Qunused-arguments -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -Werror=unknown-warning-option -Werror=ignored-optimization-argument -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -Wno-frame-address -Wno-address-of-packed-member -O2 -Wframe-larger-than=2048 -fstack-protector-strong -Werror \"-Wimplicit-fallthrough\" -Wno-gnu -mno-global-merge -Wno-unused-but-set-variable -Wno-unused-const-variable -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -DCC_USING_NOP_MCOUNT -DCC_USING_FENTRY -fno-lto -flto -fvisibility=hidden -falign-functions=64 -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-array-bounds -fno-strict-overflow -fno-stack-check -Werror=date-time -Werror=incompatible-pointer-types -Wno-initializer-overrides -Wno-format -Wno-sign-compare -Wno-format-zero-length -Wno-pointer-to-enum-cast -Wno-tautological-constant-out-of-range-compare -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp -DMODULE -DKBUILD_BASENAME='\"file\"' -DKBUILD_MODNAME='\"overlay\"' -D__KBUILD_MODNAME=kmod_overlay -c -o fs/overlayfs/file.o fs/overlayfs/file.c We can take that clang command and use it to generate fs/overlayfs/file.o from fs/overlayfs/file.i to make sure the issue is completely reproducible outside of the kernel’s build system. To do so, I like to copy the files into a separate folder and work within there.\n$ tmp_dir=$(mktemp -d) $ cp fs/overlayfs/file.i \"$tmp_dir\" $ cd \"$tmp_dir\" Now, the clang command has several flags in it that we do not need:\nAny of the flags prior to -Wall and define flags (-D...) since those are all preprocessor flags (the file has already been preprocessed at this stage). All of the warning flags (-W...) are pointless, as they cannot cause code generation to change. The --target flag is redundant, as we are on an x86_64 Linux platform, along with -fintegrated-as, as that is the default for x86_64 on Linux (it is only present in the command to make figuring out the assembler easier for the Kconfig stage). Lastly, we need to adjust the paths of the source files and output to be relative to our new temporary directory. So, we end up with:\nclang -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -O2 -fstack-protector-strong -mno-global-merge -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -flto -fvisibility=hidden -falign-functions=64 -fno-strict-overflow -fno-stack-check -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp -c -o file.o file.i Now, we can put the commands that we need to reproduce the issue into a simple shell script. For the ld.lld, we do not care about the location of the output (-o ...) because we are not analyzing it, so I just dump it to /dev/null. I also know the -mllvm -import-instr-limit=5 is not critical for reproducing this bug so we can drop it here.\n$ cat test.sh #!/usr/bin/env bash llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin $llvm_bin/clang -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -O2 -fstack-protector-strong -mno-global-merge -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -flto -fvisibility=hidden -falign-functions=64 -fno-strict-overflow -fno-stack-check -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp -c -o file.o file.i $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o $ chmod +x test.sh $ ./test.sh ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') Before we move on, we should trim down the compiler flags, as some of them may not be necessary to reproduce the issue. Dropping flags after this point is definitely possible but doing it now can help creduce or cvise really tease out the source code that triggers the problem, as your interesting test can be written in a clearer manner (more on that later). There is not really any art to this; I will typically remove four to five flags at a time to see if I can reproduce the issue. If it does, the flags were not important but if it doesn’t, the flag needs to stick around (the Linux kernel is no longer buildable without optimizations so -Os/-O2/-O3 will almost always be needed). After running through that process with this issue, we end up with:\n$ cat test.sh #!/usr/bin/env bash llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin $llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o $ ./test.sh ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') Sweet! We have a single preprocessed file that we can use to reproduce the issue with two simple commands. Now, we can reduce this input using either creduce or a more recent Python implementation called cvise. They work the same but I prefer cvise, as it appears to be faster for me and it produces more readable C code (as it keeps function and variable names from the original source).\nWriting a good interestingness test and running the reduction NOTE: This is distilled down from the official “Using C-Reduce” documentation. If I say something that contradicts the documentation, assume the documentation is correct (but drop me a note so I can tell).\ncreduce and cvise work by running a shell script against the input and checking the return code of the script to determine if the bug is still present (so the source can be reduced further) or not (so it can undo the test it just tried). 0 is considered “interesting” and non-zero is not (source is invalid, other build errors, etc).\nSo in this case, we might want our interestingness test to look something like:\n#!/usr/bin/env bash # Location of your built toolchain's bin/ folder llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin # If the source cannot be compiled with LTO and '-fsanitize=object-size', it is not interesting (we know the source builds at the beginning) $llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit # If \"error: Never resolved function from blockaddress\" is present, the test is interesting (grep returns 0 when the string is found) $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |\u0026 grep \"error: Never resolved function from blockaddress\" Running this, we get:\n$ ./test.sh ... ld.lld: error: Never resolved function from blockaddress (Producer: 'LLVM14.0.0git' Reader: 'LLVM 14.0.0git') $ echo $? 0 Now, we want to make sure creduce/cvise gives us code that stresses the error under these specific conditions and not others. For this reason, I typically write two other tests within my interestingness test. The first is making sure that creduce/cvise does not introduce new warnings under either GCC and clang; this also makes sure the code is accepted by two compilers, which improves its quality. This directly contradicts note #3 in the cvise README but I have seen some dumb looking code generated from these tools so keeping it somewhat warning clean makes that less likely. The one downside of this is it typically makes the reduction take longer so keep that in mind if you decide to add it.\nFirst, let’s try to build the source with gcc (as mentioned above, the Linux kernel requires optimizations to build so we add -O2):\n$ gcc -O2 -c -o /dev/null file.i ... $ echo $? 0 Adding -Werror will turn all of the warnings that we currently see into errors so we need to add -Wno-error=... for the warnings that do show up. For gcc, I only see -Wattributes.\n$ gcc -O2 -Werror -Wno-error=attributes -c -o /dev/null file.i ... $ echo $? 0 Next, we want to test with clang in a similar manner, which we end up with:\n$ clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i ... $ echo $? 0 Lastly, I want GCC to try and catch any instances of -Waddress-of-packed-member or -Wunused-value that might crop up in various passes, which we cannot catch with clang because the source is not currently clean (we could try to fix that in the actual source file but this is a little bit easier).\nNow, we can throw these lines into our interestingness test:\n$ cat test.sh #!/usr/bin/env bash # Location of your built toolchain's bin/ folder llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin # New warnings or invalid source are not interesting (smoke test) gcc -O2 -Werror -Werror={address-of-packed-member,unused-value} -Wno-error=attributes -c -o /dev/null file.i || exit $llvm_bin/clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i || exit # If the source cannot be compiled with LTO and '-fsanitize=object-size', it is not interesting (we know the source builds at the beginning) $llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit # If \"error: Never resolved function from blockaddress\" is present, the test is interesting (grep returns 0 when the string is found) $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |\u0026 grep \"error: Never resolved function from blockaddress\" $ ./test.sh ... $ echo $? 0 The second test I like to add is only relevant if the issue is reproducible under a combination of flags. In these cases, I like to make sure the issue is not reproducible when using a subset of the flags, as that will sometimes help show the issue a little bit clearer (as I mentioned before when reducing down compiler flags). For example, the bug we are looking into is only reproducible with -flto when it is used in combination with -fsanitize=object-size so I want to make sure the issue does not show up when only using -flto or -fsanitize=object-size, as that would be a different bug than the one we are reducing. It would still be worth looking into but the reduced file would not be stressing the bug in the best way.\nAdding these tests would look something like:\n$ cat test.sh #!/usr/bin/env bash # Location of your built toolchain's bin/ folder llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin # New warnings or invalid source are not interesting (smoke test) gcc -O2 -Werror -Werror={address-of-packed-member,unused-value} -Wno-error=attributes -c -o /dev/null file.i || exit $llvm_bin/clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i || exit # If the source cannot be compiling and linked with '-fsanitize=object-size' without LTO, it is not interesting $llvm_bin/clang -O2 -fsanitize=object-size -c -o file.o file.i || exit $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o || exit # If the source cannot be compiled and linked with LTO without '-fsanitize=object-size', it is not interesting $llvm_bin/clang -O2 -flto -c -o file.o file.i || exit $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o || exit # If the source cannot be compiled with LTO and '-fsanitize=object-size', it is not interesting (we know the source builds at the beginning) $llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit # If \"error: Never resolved function from blockaddress\" is present, the test is interesting (grep returns 0 when the string is found) $llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |\u0026 grep \"error: Never resolved function from blockaddress\" $ ./test.sh ... $ echo $? 0 Now that we have a fully formed interestingness test, we can run cvise. Depending on how many tests it runs in parallel and the speed of your machine, this might take a while.\n$ cvise test.sh file.i 00:00:02 INFO ===\u003c 13 \u003e=== 00:00:02 INFO running 32 interestingness tests in parallel 00:00:02 INFO INITIAL PASSES 00:00:02 INFO ===\u003c IncludesPass \u003e=== 00:00:02 INFO ===\u003c UnIfDefPass \u003e=== 00:00:02 INFO ===\u003c CommentsPass \u003e=== 00:00:05 INFO (0.0%, 2217001 bytes, 31799 lines) ... Runtime: 5975 seconds Reduced test-cases: --- /home/nathan/cbl/creduce-files/cbl-1215/file.i --- struct fd { int file; } kmem_cache_alloc(), ovl_write_iter_real; struct { int dep_map; } * percpu_rwsem_release_sem; struct { void *ki_complete; } * is_sync_kiocb_kiocb; void *ovl_write_iter___trans_tmp_4; _Bool ovl_write_iter___trans_tmp_3; void lock_release(int *, long); static void percpu_rwsem_release(long ip) { lock_release(\u0026percpu_rwsem_release_sem-\u003edep_map, ip); } int file_remove_privs(); long ovl_write_iter() { long ret = file_remove_privs(); if (ret) goto out_unlock; ret = (\u0026ovl_write_iter_real)-\u003efile; if (ret) goto out_unlock; ovl_write_iter___trans_tmp_3 = is_sync_kiocb_kiocb-\u003eki_complete == 0; if (ovl_write_iter___trans_tmp_3) { kmem_cache_alloc(); if (ovl_write_iter___trans_tmp_4) goto out; percpu_rwsem_release(({ __here: (long)\u0026\u0026__here; })); } out: out_unlock: return ret; } So the reduction took a little over an hour and a half and now it is a lot easier for an LLVM developer to take that small C program, transform it into LLVM IR, and figure out what is going wrong here. The difference is crazy (0.08% the original size!):\n$ wc -l file.i{,.orig} 37 file.i 44372 file.i.orig 44409 total Conclusion Providing developers a small, concise reproducer is important so that all their time can spent debugging and fixing the issue; otherwise, they are less likely to respond to the report, as it will take more work on their part than another issue where the reproducer is ready and available. Hopefully this post was informative! If there are any issues, comments, or improvements, feel free to reach out to me via email or Twitter.\n",
  "wordCount" : "3889",
  "inLanguage": "en",
  "datePublished": "2021-11-29T10:07:16-07:00",
  "dateModified": "2021-11-29T10:07:16-07:00",
  "author":{
    "@type": "Person",
    "name": "Nathan Chancellor"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://nathanchance.dev/posts/cvise-lto-kernel-bug/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nathan Chancellor",
    "logo": {
      "@type": "ImageObject",
      "url": "https://nathanchance.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://nathanchance.dev/" accesskey="h" title="Nathan Chancellor (Alt + H)">Nathan Chancellor</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://nathanchance.dev/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/nc_resume.pdf" title="Resume">
                    <span>Resume</span>
                </a>
            </li>
            <li>
                <a href="https://nathanchance.dev/downloads/" title="Downloads">
                    <span>Downloads</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Reducing an LTO Linux kernel bug with cvise
    </h1>
    <div class="post-meta"><span title='2021-11-29 10:07:16 -0700 MST'>November 29, 2021</span>&nbsp;·&nbsp;19 min&nbsp;·&nbsp;Nathan Chancellor&nbsp;|&nbsp;<a href="https://github.com/nathanchance/hugo-files/blob/main/content/posts/cvise-lto-kernel-bug.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#make-sure-the-bug-is-reproducible" aria-label="Make sure the bug is reproducible">Make sure the bug is reproducible</a></li>
                <li>
                    <a href="#reproduce-the-bug-with-the-latest-compiler" aria-label="Reproduce the bug with the latest compiler">Reproduce the bug with the latest compiler</a></li>
                <li>
                    <a href="#reproduce-the-issue-outside-of-the-build-system" aria-label="Reproduce the issue outside of the build system">Reproduce the issue outside of the build system</a></li>
                <li>
                    <a href="#writing-a-good-interestingness-test-and-running-the-reduction" aria-label="Writing a good interestingness test and running the reduction">Writing a good interestingness test and running the reduction</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>My co-maintainer Nick Desaulniers wrote <a href="https://nickdesaulniers.github.io/blog/2019/01/18/finding-compiler-bugs-with-c-reduce/">a great post</a> about taking a several thousand line C file that exposed a compiler bug down to 12 lines with <code>creduce</code>. I thought I would do the same thing with a bug that only happens with link time optimization (LTO) in the Linux kernel, which is a bit of a different beast. Hopefully this post can help others reduce their own bugs and think about the best way to triage a bug.</p>
<h2 id="make-sure-the-bug-is-reproducible">Make sure the bug is reproducible<a hidden class="anchor" aria-hidden="true" href="#make-sure-the-bug-is-reproducible">#</a></h2>
<p>Any time that I receive a bug report on <a href="https://github.com/ClangBuiltLinux/linux/issues">our GitHub issue tracker</a>, I want to make sure it is reproducible for me so that I can investigate it in my environment with my tools. The report in question is <a href="https://github.com/ClangBuiltLinux/linux/issues/1215">issue #1215</a> and <a href="https://github.com/ClangBuiltLinux/linux/issues/1516">issue #1516</a>. The second issue has a set of configurations that trigger the issue with either <code>ARCH=x86_64</code> or <code>ARCH=arm64</code>; as I am working on an x86_64 server, it is probably going to be easier to work with the native architecture.</p>
<p>I like to use <a href="https://gitlab.com/Linaro/tuxmake"><code>tuxmake</code></a> for initially reproducing bugs with Debian <code>clang</code> versions, as they are prepacked in Docker images. I won&rsquo;t get into the specifics of how to use <code>tuxmake</code> in this post, its documentation is pretty good as it is and I am only going to use it for initially reproducing the issue. The reporter of issue #1516 mentions they are using the latest stable branch (<code>linux-5.15.y</code>) but I want to reproduce on mainline, as that is going to change how I approach this bug. If the bug is fixed on mainline and broken on stable, it means there was a fix somewhere that needs to be found and backported, which is much simpler than fixing an issue that is still present in the development tree.</p>
<pre tabindex="0"><code>$ git show -s
commit d58071a8a76d779eedab38033ae4c821c30295a5 (HEAD, tag: v5.16-rc3, origin/master)
Author: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Date:   Sun Nov 28 14:09:19 2021 -0800

    Linux 5.16-rc3

$ echo &#34;CONFIG_FTRACE_MCOUNT_USE_RECORDMCOUNT=n
CONFIG_KASAN=n
CONFIG_GCOV_KERNEL=n
CONFIG_COMPILE_TEST=n
CONFIG_LTO_CLANG_FULL=y
CONFIG_TRIM_UNUSED_KSYMS=y
CONFIG_CFI_CLANG=y
CONFIG_CFI_CLANG_SHADOW=y
CONFIG_SHADOW_CALL_STACK=y
CONFIG_INIT_STACK_ALL_ZERO=y&#34; &gt;kernel/configs/repro.config

$ tuxmake \
    -a x86_64 \
    -k allmodconfig \
    -K repro.config \
    -r podman \
    -t clang-13 \
    LLVM=1 LLVM_IAS=1 default
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM13.0.1&#39; Reader: &#39;LLVM 13.0.1&#39;)
make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM13.0.1&#39; Reader: &#39;LLVM 13.0.1&#39;)
make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1
...
</code></pre><p>Okay, so the bug is reproducible locally. Now, I know that some of these configuration options are not needed to reproduce the issue. <code>CONFIG_CFI_CLANG</code> and <code>CONFIG_CFI_CLANG_SHADOW</code> do not currently work for x86_64. <code>CONFIG_SHADOW_CALL_STACK</code> is an arm64 only feature. <code>CONFIG_FTRACE_MCOUNT_USE_RECORDMCOUNT</code> is not a user selectable Kconfig value (it is just <code>bool</code>, rather than <code>bool &quot;...&quot;</code>). <code>CONFIG_INIT_STACK_ALL_ZERO</code> and <code>CONFIG_TRIM_UNUSED_KSYMS</code> are a little suspect but let&rsquo;s see if we can reproduce this bug without them to keep our scope more limited (fewer variables can make the bug easier to fix down the road).</p>
<p><code>CONFIG_LTO_CLANG_FULL</code> appears critical to the problem and <code>CONFIG_KASAN</code>, <code>CONFIG_GCOV_KERNEL</code>, and <code>CONFIG_COMPILE_TEST</code> all need to be disabled for it to be selected. So:</p>
<pre tabindex="0"><code>$ echo &#34;CONFIG_COMPILE_TEST=n
CONFIG_GCOV_KERNEL=n
CONFIG_KASAN=n
CONFIG_LTO_CLANG_FULL=y&#34; &gt;kernel/configs/repro.config

$ tuxmake \
    -a x86_64 \
    -k allmodconfig \
    -K repro.config \
    -r podman \
    -t clang-13 \
    LLVM=1 LLVM_IAS=1 default
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM13.0.1&#39; Reader: &#39;LLVM 13.0.1&#39;)
make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM13.0.1&#39; Reader: &#39;LLVM 13.0.1&#39;)
make[3]: *** [/home/nathan/cbl/worktrees/cbl-1215/scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1
...
I: config: PASS in 0:00:07.230375
I: default: FAIL in 0:09:36.347980
I: build output in /home/nathan/.cache/tuxmake/builds/273
</code></pre><p>Alright, we have a decently minimal configuration (<code>allmodconfig</code> with full LTO) to work off of. Take note of the <code>.../.cache/tuxmake/builds/273</code>, that will come in handy later.</p>
<h2 id="reproduce-the-bug-with-the-latest-compiler">Reproduce the bug with the latest compiler<a hidden class="anchor" aria-hidden="true" href="#reproduce-the-bug-with-the-latest-compiler">#</a></h2>
<p>We reproduced the bug with the latest Linux kernel development release but we used a released version of <code>clang</code> (13). For the same reason as above, we want to make sure the bug is not already fixed with the development branch, as duplicate reports waste developers&rsquo; time. <a href="https://apt.llvm.org/">apt.llvm.org</a> is a great resource for quickly getting access to a close to tip of tree <code>clang</code> to test with, if you are on Debian/Ubuntu or willing to work out of a Docker image. For the purpose of this tutorial, we are just going to build it from source. I developed a Python LLVM build script (<code>build-llvm.py</code>) as part of <a href="https://github.com/ClangBuiltLinux/tc-build">tc-build</a> to help with situations like this.</p>
<p>I will explain the flags below:</p>
<ul>
<li><code>--build-folder</code>/<code>--llvm-folder</code>: By default, the script keeps everything self-contained; it builds the toolchain in <code>build/</code> and it downloads the source to <code>llvm-project/</code>. I have a separate tree that I use for development so I provide these flags to point those folders to that tree. These will not be necessary under normal circumstances.</li>
<li><code>--assertions</code>: Turns on assertions in the LLVM source, which can help figure out the cause of the bug sooner, but it will make the compiler slower; it might not be worth the trade off depending on what you are reducing.</li>
<li><code>--build-stage1-only</code>: Shortens the build time, as the script normally builds a compiler and uses that compiler to build the final compiler (a two stage build). When using the toolchain for more than a triage, this should be omitted, as a two stage build can produce a more optimized compiler.</li>
<li><code>--check-targets</code>: Runs the check targets requested (<code>clang</code> will become <code>check-clang</code>) to make sure there are no current obvious issues with the development tree.</li>
<li><code>--projects</code>: Limits what we build to <code>clang</code> and <code>ld.lld</code>, as we do not need any other projects to reproduce this.</li>
<li><code>--targets</code>: Limits the available backends to just <code>X86</code>, which is the only one we need to reproduce the issue, to help speed up the build.</li>
</ul>
<pre tabindex="0"><code>$ $CBL_GIT/tc-build/build-llvm.py \
    --assertions \
    --build-folder $CBL_SRC/llvm-project/build \
    --build-stage1-only \
    --check-targets clang ll{d,vm{,-unit}} \
    --llvm-folder $CBL_SRC/llvm-project \
    --projects &#34;clang;lld&#34; \
    --targets X86
...

LLVM build duration: 0:06:02

LLVM toolchain installed to: /home/nathan/cbl/src/llvm-project/build/stage1

To use, either run:

    $ export PATH=/home/nathan/cbl/src/llvm-project/build/stage1/bin:${PATH}

or add:

    PATH=/home/nathan/cbl/src/llvm-project/build/stage1/bin:${PATH}

to the command you want to use this toolchain.

Version information:

ClangBuiltLinux clang version 14.0.0 (https://github.com/llvm/llvm-project 8d474f1d157530577f06ce3ef9187e1aaf31a59e)
Target: x86_64-unknown-linux-gnu
Thread model: posix
InstalledDir: /home/nathan/cbl/src/llvm-project/build/stage1/bin

LLD 14.0.0 (compatible with GNU linkers)
</code></pre><p>After a little bit of time (or maybe a lot of time, depending on how fast your machine is), the script will spit out some information like above, which explains how we can use it.</p>
<p>One nice thing about <code>tuxmake</code> is that it generates a <code>config</code> file that we can use to reproduce issues later (that is why I mentioned taking note of the folder that <code>tuxmake</code> generates at the end). Thus, with the new toolchain and the old config, we can see if the issue is still reproducible:</p>
<pre tabindex="0"><code>$ cp $HOME/.cache/tuxmake/builds/273/config .config

$ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \
    make -skj&#34;$(nproc)&#34; LLVM=1 LLVM_IAS=1 olddefconfig all
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)
make[3]: *** [scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1
...
drivers/gpu/drm/i915/intel_pm.c:3065:12: error: use of bitwise &#39;|&#39; with boolean operands [-Werror,-Wbitwise-instead-of-logical]
        changed = ilk_increase_wm_latency(dev_priv, dev_priv-&gt;wm.pri_latency, 12) |
                  ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
drivers/gpu/drm/i915/intel_pm.c:3065:12: note: cast one or both operands to int to silence this warning
drivers/gpu/drm/i915/intel_pm.c:3065:12: error: use of bitwise &#39;|&#39; with boolean operands [-Werror,-Wbitwise-instead-of-logical]
        changed = ilk_increase_wm_latency(dev_priv, dev_priv-&gt;wm.pri_latency, 12) |
                  ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                                                                  ||
drivers/gpu/drm/i915/intel_pm.c:3065:12: note: cast one or both operands to int to silence this warning
2 errors generated.
...
drivers/power/reset/ltc2952-poweroff.c:162:28: error: expression requires  &#39;long double&#39; type support, but target &#39;x86_64-unknown-linux-gnu&#39; does not support it
        data-&gt;wde_interval = 300L * 1E6L;
                                  ^
drivers/power/reset/ltc2952-poweroff.c:162:21: error: expression requires  &#39;long double&#39; type support, but target &#39;x86_64-unknown-linux-gnu&#39; does not support it
        data-&gt;wde_interval = 300L * 1E6L;
                           ^
drivers/power/reset/ltc2952-poweroff.c:163:41: error: expression requires  &#39;long double&#39; type support, but target &#39;x86_64-unknown-linux-gnu&#39; does not support it
        data-&gt;trigger_delay = ktime_set(2, 500L*1E6L);
                                               ^
3 errors generated.
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)
make[3]: *** [scripts/Makefile.build:307: fs/xfs/xfs.lto.o] Error 1
...
</code></pre><p>So the issue reproduces but we picked up a couple new issues by the nature of going to a development build of LLVM. These are not going to impact our triage but it is still good to fix them. Thankfully, patches to fix these issues exist on the mailing list:</p>
<pre tabindex="0"><code>$ curl -LSs https://lore.kernel.org/lkml/20211014211916.3550122-1-nathan@kernel.org/raw | patch -Np1
patching file drivers/gpu/drm/i915/intel_pm.c
Hunk #1 succeeded at 3062 (offset 12 lines).

$ curl -LSs https://lore.kernel.org/lkml/20211105152049.2522250-1-nathan@kernel.org/raw | patch -Np1
patching file drivers/power/reset/ltc2952-poweroff.c
</code></pre><p>Running the above command again should just show the two errors now.</p>
<h2 id="reproduce-the-issue-outside-of-the-build-system">Reproduce the issue outside of the build system<a hidden class="anchor" aria-hidden="true" href="#reproduce-the-issue-outside-of-the-build-system">#</a></h2>
<p>The next step is getting the files that we need to reproduce the issue separated from the build system. We can choose to look at <code>fs/overlayfs/overlay.lto.o</code> or <code>fs/xfs/xfs.lto.o</code>; I am going to choose the former, as <code>fs/overlayfs/</code> is a smaller directory than <code>fs/xfs/</code>.</p>
<p>The Linux kernel&rsquo;s build system has a variable <code>V=1</code> to see every build step, which we can dump to a text file for easy inspection and searching. Note: the <code>-s</code> flag needs to be dropped from <code>make</code> to get the full output.</p>
<pre tabindex="0"><code>$ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \
    make -kj&#34;$(nproc)&#34; LLVM=1 LLVM_IAS=1 olddefconfig clean all V=1 &amp;&gt;build.log
</code></pre><p>First, we need to see how <code>fs/overlayfs/overlay.lto.o</code> is generated.</p>
<pre tabindex="0"><code>$ rg fs/overlayfs/overlay.lto.o build.log
6011:  ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5   -r -o fs/overlayfs/overlay.lto.o  --whole-archive fs/overlayfs/overlay.o  ; ./tools/objtool/objtool orc generate  --module  --no-fp  --no-unreachable  --retpoline  --uaccess  --mcount fs/overlayfs/overlay.lto.o
6133:make[3]: *** [scripts/Makefile.build:307: fs/overlayfs/overlay.lto.o] Error 1
</code></pre><p>It comes from <code>fs/overlayfs/overlay.o</code> so we need to see how that is generated.</p>
<pre tabindex="0"><code>$ rg fs/overlayfs/overlay.o build.log
29599:  rm -f fs/overlayfs/overlay.o.symversions                  ; rm -f fs/overlayfs/overlay.o; llvm-ar cDPrsT fs/overlayfs/overlay.o fs/overlayfs/super.o fs/overlayfs/namei.o fs/overlayfs/util.o fs/overlayfs/inode.o fs/overlayfs/file.o fs/overlayfs/dir.o fs/overlayfs/readdir.o fs/overlayfs/copy_up.o fs/overlayfs/export.o
29634:  ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5   -r -o fs/overlayfs/overlay.lto.o  --whole-archive fs/overlayfs/overlay.o  ; ./tools/objtool/objtool orc generate  --module  --no-fp  --no-unreachable  --retpoline  --uaccess  --mcount fs/overlayfs/overlay.lto.o
</code></pre><p>It comes from running <code>llvm-ar</code> on a bunch of <code>.o</code> files in <code>fs/overlayfs/</code>. Now we need to figure out which <code>.o</code> has the issue. This can be done by running the <code>ld.lld</code> command with a single <code>.o</code> files from the <code>llvm-ar</code> command (<code>llvm-ar</code> is only necessary for combining multiple <code>.o</code> files into one). For example, with <code>fs/overlayfs/super.o</code>:</p>
<pre tabindex="0"><code>$ rm fs/overlayfs/overlay.o

$ $CBL_SRC/llvm-project/build/stage1/bin/ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/super.o

$ echo $?
0
</code></pre><p>So the issue is not with <code>fs/overlayfs/super.c</code>. Trying all the other files, we end up seeing the error in <code>fs/overlayfs/file.c</code>:</p>
<pre tabindex="0"><code>$ rm fs/overlayfs/overlay.o

$ $CBL_SRC/llvm-project/build/stage1/bin/ld.lld -m elf_x86_64 -mllvm -import-instr-limit=5 -r -o fs/overlayfs/overlay.lto.o --whole-archive fs/overlayfs/file.o
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)
</code></pre><p>Okay, we have a single C file that can reproduce the issue, which we can reduce from. The Linux kernel allows us to generate a preprocessed file (<code>.i</code>) from source files (<code>.c</code>) directly, which is important for reduction purposes as it will be one file that can be built anywhere, rather than being tied to a build system and headers. The other thing we need is the build command for the object file (<code>.o</code>) so we know what flags to use for reproducing the issue. The kernel&rsquo;s build system generates <code>.cmd</code> to show the command used to build the object file but these only show up when the object file can be successfully built. If you are reducing a build error on the object file, you can use the <code>V=1</code> trick above to see the command. So, putting that all together:</p>
<pre tabindex="0"><code># Generate the &#39;.i&#39; and &#39;.o&#39; files
$ PATH=$CBL_SRC/llvm-project/build/stage1/bin:$PATH \
    make -kj&#34;$(nproc)&#34; LLVM=1 LLVM_IAS=1 olddefconfig clean fs/overlayfs/file.{i,o}

# Get the compiler command from the .cmd file
$ head -1 fs/overlayfs/.file.o.cmd
cmd_fs/overlayfs/file.o := clang -Wp,-MMD,fs/overlayfs/.file.o.d -nostdinc -I./arch/x86/include -I./arch/x86/include/generated  -I./include -I./arch/x86/include/uapi -I./arch/x86/include/generated/uapi -I./include/uapi -I./include/generated/uapi -include ./include/linux/compiler-version.h -include ./include/linux/kconfig.h -include ./include/linux/compiler_types.h -D__KERNEL__ -Qunused-arguments -fmacro-prefix-map=./= -Wall -Wundef -Werror=strict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -Werror=implicit-function-declaration -Werror=implicit-int -Werror=return-type -Wno-format-security -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -Werror=unknown-warning-option -Werror=ignored-optimization-argument -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -DCONFIG_X86_X32_ABI -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -Wno-frame-address -Wno-address-of-packed-member -O2 -Wframe-larger-than=2048 -fstack-protector-strong -Werror &#34;-Wimplicit-fallthrough&#34; -Wno-gnu -mno-global-merge -Wno-unused-but-set-variable -Wno-unused-const-variable -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -DCC_USING_NOP_MCOUNT -DCC_USING_FENTRY -fno-lto -flto -fvisibility=hidden -falign-functions=64 -Wdeclaration-after-statement -Wvla -Wno-pointer-sign -Wno-array-bounds -fno-strict-overflow -fno-stack-check -Werror=date-time -Werror=incompatible-pointer-types -Wno-initializer-overrides -Wno-format -Wno-sign-compare -Wno-format-zero-length -Wno-pointer-to-enum-cast -Wno-tautological-constant-out-of-range-compare  -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum  -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp  -DMODULE  -DKBUILD_BASENAME=&#39;&#34;file&#34;&#39; -DKBUILD_MODNAME=&#39;&#34;overlay&#34;&#39; -D__KBUILD_MODNAME=kmod_overlay -c -o fs/overlayfs/file.o fs/overlayfs/file.c
</code></pre><p>We can take that <code>clang</code> command and use it to generate <code>fs/overlayfs/file.o</code> from <code>fs/overlayfs/file.i</code> to make sure the issue is completely reproducible outside of the kernel&rsquo;s build system. To do so, I like to copy the files into a separate folder and work within there.</p>
<pre tabindex="0"><code>$ tmp_dir=$(mktemp -d)

$ cp fs/overlayfs/file.i &#34;$tmp_dir&#34;

$ cd &#34;$tmp_dir&#34;
</code></pre><p>Now, the clang command has several flags in it that we do not need:</p>
<ul>
<li>Any of the flags prior to <code>-Wall</code> and define flags (<code>-D...</code>) since those are all preprocessor flags (the file has already been preprocessed at this stage).</li>
<li>All of the warning flags (<code>-W...</code>) are pointless, as they cannot cause code generation to change.</li>
<li>The <code>--target</code> flag is redundant, as we are on an x86_64 Linux platform, along with <code>-fintegrated-as</code>, as that is the default for x86_64 on Linux (it is only present in the command to make figuring out the assembler easier for the Kconfig stage).</li>
<li>Lastly, we need to adjust the paths of the source files and output to be relative to our new temporary directory.</li>
</ul>
<p>So, we end up with:</p>
<pre tabindex="0"><code>clang -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -O2 -fstack-protector-strong -mno-global-merge -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -flto -fvisibility=hidden -falign-functions=64 -fno-strict-overflow -fno-stack-check -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp -c -o file.o file.i
</code></pre><p>Now, we can put the commands that we need to reproduce the issue into a simple shell script. For the <code>ld.lld</code>, we do not care about the location of the output (<code>-o ...</code>) because we are not analyzing it, so I just dump it to <code>/dev/null</code>. I also know the <code>-mllvm -import-instr-limit=5</code> is not critical for reproducing this bug so we can drop it here.</p>
<pre tabindex="0"><code>$ cat test.sh
#!/usr/bin/env bash

llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin

$llvm_bin/clang -fno-strict-aliasing -fno-common -fshort-wchar -fno-PIE -std=gnu89 --target=x86_64-linux-gnu -fintegrated-as -mno-sse -mno-mmx -mno-sse2 -mno-3dnow -mno-avx -fcf-protection=none -m64 -falign-loops=1 -mno-80387 -mno-fp-ret-in-387 -mstack-alignment=8 -mskip-rax-setup -mtune=generic -mno-red-zone -mcmodel=kernel -Wno-sign-compare -fno-asynchronous-unwind-tables -mretpoline-external-thunk -fno-delete-null-pointer-checks -O2 -fstack-protector-strong -mno-global-merge -ftrivial-auto-var-init=pattern -fno-stack-clash-protection -pg -mfentry -flto -fvisibility=hidden -falign-functions=64 -fno-strict-overflow -fno-stack-check -fsanitize=array-bounds -fsanitize=shift -fsanitize=integer-divide-by-zero -fsanitize=object-size -fsanitize=bool -fsanitize=enum -fsanitize-coverage=trace-pc -fsanitize-coverage=trace-cmp -c -o file.o file.i

$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o

$ chmod +x test.sh

$ ./test.sh
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)
</code></pre><p>Before we move on, we should trim down the compiler flags, as some of them may not be necessary to reproduce the issue. Dropping flags after this point is definitely possible but doing it now can help <code>creduce</code> or <code>cvise</code> really tease out the source code that triggers the problem, as your interesting test can be written in a clearer manner (more on that later). There is not really any art to this; I will typically remove four to five flags at a time to see if I can reproduce the issue. If it does, the flags were not important but if it doesn&rsquo;t, the flag needs to stick around (the Linux kernel is no longer buildable without optimizations so <code>-Os</code>/<code>-O2</code>/<code>-O3</code> will almost always be needed). After running through that process with this issue, we end up with:</p>
<pre tabindex="0"><code>$ cat test.sh
#!/usr/bin/env bash

llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin

$llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i

$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o

$ ./test.sh
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)
</code></pre><p>Sweet! We have a single preprocessed file that we can use to reproduce the issue with two simple commands. Now, we can reduce this input using either <code>creduce</code> or a more recent Python implementation called <a href="https://github.com/marxin/cvise"><code>cvise</code></a>. They work the same but I prefer <code>cvise</code>, as it appears to be faster for me and it produces more readable C code (as it keeps function and variable names from the original source).</p>
<h2 id="writing-a-good-interestingness-test-and-running-the-reduction">Writing a good interestingness test and running the reduction<a hidden class="anchor" aria-hidden="true" href="#writing-a-good-interestingness-test-and-running-the-reduction">#</a></h2>
<p>NOTE: This is distilled down from <a href="https://embed.cs.utah.edu/creduce/using/">the official &ldquo;Using C-Reduce&rdquo; documentation</a>. If I say something that contradicts the documentation, assume the documentation is correct (but drop me a note so I can tell).</p>
<p><code>creduce</code> and <code>cvise</code> work by running a shell script against the input and checking the return code of the script to determine if the bug is still present (so the source can be reduced further) or not (so it can undo the test it just tried). 0 is considered &ldquo;interesting&rdquo; and non-zero is not (source is invalid, other build errors, etc).</p>
<p>So in this case, we might want our interestingness test to look something like:</p>
<pre tabindex="0"><code>#!/usr/bin/env bash

# Location of your built toolchain&#39;s bin/ folder
llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin

# If the source cannot be compiled with LTO and &#39;-fsanitize=object-size&#39;, it is not interesting (we know the source builds at the beginning)
$llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit

# If &#34;error: Never resolved function from blockaddress&#34; is present, the test is interesting (grep returns 0 when the string is found)
$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |&amp; grep &#34;error: Never resolved function from blockaddress&#34;
</code></pre><p>Running this, we get:</p>
<pre tabindex="0"><code>$ ./test.sh
...
ld.lld: error: Never resolved function from blockaddress (Producer: &#39;LLVM14.0.0git&#39; Reader: &#39;LLVM 14.0.0git&#39;)

$ echo $?
0
</code></pre><p>Now, we want to make sure <code>creduce</code>/<code>cvise</code> gives us code that stresses the error under these specific conditions and not others. For this reason, I typically write two other tests within my interestingness test. The first is making sure that <code>creduce</code>/<code>cvise</code> does not introduce new warnings under either GCC and <code>clang</code>; this also makes sure the code is accepted by two compilers, which improves its quality. This directly contradicts <a href="https://github.com/marxin/cvise#notes">note #3 in the <code>cvise</code> README</a> but I have seen some dumb looking code generated from these tools so keeping it somewhat warning clean makes that less likely. The one downside of this is it typically makes the reduction take longer so keep that in mind if you decide to add it.</p>
<p>First, let&rsquo;s try to build the source with <code>gcc</code> (as mentioned above, the Linux kernel requires optimizations to build so we add <code>-O2</code>):</p>
<pre tabindex="0"><code>$ gcc -O2 -c -o /dev/null file.i
...

$ echo $?
0
</code></pre><p>Adding <code>-Werror</code> will turn all of the warnings that we currently see into errors so we need to add <code>-Wno-error=...</code> for the warnings that do show up. For <code>gcc</code>, I only see <code>-Wattributes</code>.</p>
<pre tabindex="0"><code>$ gcc -O2 -Werror -Wno-error=attributes -c -o /dev/null file.i
...

$ echo $?
0
</code></pre><p>Next, we want to test with <code>clang</code> in a similar manner, which we end up with:</p>
<pre tabindex="0"><code>$ clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i
...

$ echo $?
0
</code></pre><p>Lastly, I want GCC to try and catch any instances of <code>-Waddress-of-packed-member</code> or <code>-Wunused-value</code> that might crop up in various passes, which we cannot catch with <code>clang</code> because the source is not currently clean (we could try to fix that in the actual source file but this is a little bit easier).</p>
<p>Now, we can throw these lines into our interestingness test:</p>
<pre tabindex="0"><code>$ cat test.sh
#!/usr/bin/env bash

# Location of your built toolchain&#39;s bin/ folder
llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin

# New warnings or invalid source are not interesting (smoke test)
gcc -O2 -Werror -Werror={address-of-packed-member,unused-value} -Wno-error=attributes -c -o /dev/null file.i || exit
$llvm_bin/clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i || exit

# If the source cannot be compiled with LTO and &#39;-fsanitize=object-size&#39;, it is not interesting (we know the source builds at the beginning)
$llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit

# If &#34;error: Never resolved function from blockaddress&#34; is present, the test is interesting (grep returns 0 when the string is found)
$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |&amp; grep &#34;error: Never resolved function from blockaddress&#34;

$ ./test.sh
...

$ echo $?
0
</code></pre><p>The second test I like to add is only relevant if the issue is reproducible under a combination of flags. In these cases, I like to make sure the issue is not reproducible when using a subset of the flags, as that will sometimes help show the issue a little bit clearer (as I mentioned before when reducing down compiler flags). For example, the bug we are looking into is only reproducible with <code>-flto</code> when it is used in combination with <code>-fsanitize=object-size</code> so I want to make sure the issue does not show up when only using <code>-flto</code> or <code>-fsanitize=object-size</code>, as that would be a different bug than the one we are reducing. It would still be worth looking into but the reduced file would not be stressing the bug in the best way.</p>
<p>Adding these tests would look something like:</p>
<pre tabindex="0"><code>$ cat test.sh
#!/usr/bin/env bash

# Location of your built toolchain&#39;s bin/ folder
llvm_bin=$CBL_SRC/llvm-project/build/stage1/bin

# New warnings or invalid source are not interesting (smoke test)
gcc -O2 -Werror -Werror={address-of-packed-member,unused-value} -Wno-error=attributes -c -o /dev/null file.i || exit
$llvm_bin/clang -O2 -Werror -Wno-error={address-of-packed-member,unused-value} -c -o /dev/null file.i || exit

# If the source cannot be compiling and linked with &#39;-fsanitize=object-size&#39; without LTO, it is not interesting
$llvm_bin/clang -O2 -fsanitize=object-size -c -o file.o file.i || exit
$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o || exit

# If the source cannot be compiled and linked with LTO without &#39;-fsanitize=object-size&#39;, it is not interesting
$llvm_bin/clang -O2 -flto -c -o file.o file.i || exit
$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o || exit

# If the source cannot be compiled with LTO and &#39;-fsanitize=object-size&#39;, it is not interesting (we know the source builds at the beginning)
$llvm_bin/clang -O2 -flto -fsanitize=object-size -c -o file.o file.i || exit

# If &#34;error: Never resolved function from blockaddress&#34; is present, the test is interesting (grep returns 0 when the string is found)
$llvm_bin/ld.lld -m elf_x86_64 -r -o /dev/null --whole-archive file.o |&amp; grep &#34;error: Never resolved function from blockaddress&#34;

$ ./test.sh
...

$ echo $?
0
</code></pre><p>Now that we have a fully formed interestingness test, we can run <code>cvise</code>. Depending on how many tests it runs in parallel and the speed of your machine, this might take a while.</p>
<pre tabindex="0"><code>$ cvise test.sh file.i
00:00:02 INFO ===&lt; 13 &gt;===
00:00:02 INFO running 32 interestingness tests in parallel
00:00:02 INFO INITIAL PASSES
00:00:02 INFO ===&lt; IncludesPass &gt;===
00:00:02 INFO ===&lt; UnIfDefPass &gt;===
00:00:02 INFO ===&lt; CommentsPass &gt;===
00:00:05 INFO (0.0%, 2217001 bytes, 31799 lines)
...
Runtime: 5975 seconds
Reduced test-cases:

--- /home/nathan/cbl/creduce-files/cbl-1215/file.i ---
struct fd {
  int file;
} kmem_cache_alloc(), ovl_write_iter_real;
struct {
  int dep_map;
} * percpu_rwsem_release_sem;
struct {
  void *ki_complete;
} * is_sync_kiocb_kiocb;
void *ovl_write_iter___trans_tmp_4;
_Bool ovl_write_iter___trans_tmp_3;
void lock_release(int *, long);
static void percpu_rwsem_release(long ip) {
  lock_release(&amp;percpu_rwsem_release_sem-&gt;dep_map, ip);
}
int file_remove_privs();
long ovl_write_iter() {
  long ret = file_remove_privs();
  if (ret)
    goto out_unlock;
  ret = (&amp;ovl_write_iter_real)-&gt;file;
  if (ret)
    goto out_unlock;
  ovl_write_iter___trans_tmp_3 = is_sync_kiocb_kiocb-&gt;ki_complete == 0;
  if (ovl_write_iter___trans_tmp_3) {
    kmem_cache_alloc();
    if (ovl_write_iter___trans_tmp_4)
      goto out;
    percpu_rwsem_release(({
      __here:
        (long)&amp;&amp;__here;
    }));
  }
out:
out_unlock:
  return ret;
}
</code></pre><p>So the reduction took a little over an hour and a half and now it is a lot easier for an LLVM developer to take that small C program, transform it into LLVM IR, and figure out what is going wrong here. The difference is crazy (0.08% the original size!):</p>
<pre tabindex="0"><code>$ wc -l file.i{,.orig}
     37 file.i
  44372 file.i.orig
  44409 total
</code></pre><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Providing developers a small, concise reproducer is important so that all their time can spent debugging and fixing the issue; otherwise, they are less likely to respond to the report, as it will take more work on their part than another issue where the reproducer is ready and available. Hopefully this post was informative! If there are any issues, comments, or improvements, feel free to reach out to me via <a href="mailto:nathan@kernel.org">email</a> or <a href="https://twitter.com/nathanchance">Twitter</a>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://nathanchance.dev/tags/clang/">Clang</a></li>
      <li><a href="https://nathanchance.dev/tags/clangbuiltlinux/">Clangbuiltlinux</a></li>
      <li><a href="https://nathanchance.dev/tags/linux/">Linux</a></li>
      <li><a href="https://nathanchance.dev/tags/llvm/">Llvm</a></li>
      <li><a href="https://nathanchance.dev/tags/lto/">Lto</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://nathanchance.dev/posts/november-2021-cbl-work/">
    <span class="title">« Prev</span>
    <br>
    <span>November 2021 ClangBuiltLinux Work</span>
  </a>
  <a class="next" href="https://nathanchance.dev/posts/october-2021-cbl-work/">
    <span class="title">Next »</span>
    <br>
    <span>October 2021 ClangBuiltLinux Work</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on x"
            href="https://x.com/intent/tweet/?text=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f&amp;hashtags=clang%2cclangbuiltlinux%2clinux%2cllvm%2clto">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f&amp;title=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise&amp;summary=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise&amp;source=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f&title=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on whatsapp"
            href="https://api.whatsapp.com/send?text=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise%20-%20https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on telegram"
            href="https://telegram.me/share/url?text=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise&amp;url=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Reducing an LTO Linux kernel bug with cvise on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Reducing%20an%20LTO%20Linux%20kernel%20bug%20with%20cvise&u=https%3a%2f%2fnathanchance.dev%2fposts%2fcvise-lto-kernel-bug%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div id="disqus_thread"></div>
<script>
    

    

    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://nathanchance.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://nathanchance.dev/">Nathan Chancellor</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
